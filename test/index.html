<!DOCTYPE html>
<meta charset="utf-8">
<html>
  <head>
  <title>COW Dashboard</title>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  
  <!-- Bootstrap -->
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">
  
  <script type="text/javascript" src="../lib/underscore/underscore-min.js" type="text/javascript"></script>
  <script type="text/javascript" src="../lib/polyfill-promise/promise-0.1.1.min.js" type="text/javascript"></script>
  
  <script type="text/javascript" src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
  <!-- IndexedDB -->
  <script type="text/javascript" src="../lib/IndexedDBShim/IndexedDBShim.min.js"></script>
  <script type="text/javascript" src="../lib/dbjs/db.js"></script>
  
  <script type="text/javascript" src="../src/cow2.utils.js"></script>
  <script type="text/javascript" src="../src/cow2.record.js"></script>
  <script type="text/javascript" src="../src/cow2.syncstore.js"></script>
  <script type="text/javascript" src="../src/cow2.peer.js"></script>
  <script type="text/javascript" src="../src/cow2.socketserver.js"></script>
  <script type="text/javascript" src="../src/cow2.user.js"></script>
  <script type="text/javascript" src="../src/cow2.group.js"></script>
  <script type="text/javascript" src="../src/cow2.item.js"></script>
  <script type="text/javascript" src="../src/cow2.project.js"></script>
  <script type="text/javascript" src="../src/cow2.websocket.js"></script>
  <script type="text/javascript" src="../src/cow2.core.js"></script>
  <script type="text/javascript" src="../src/cow2.js"></script>
  <script type="text/javascript" src="../test/cow.testsuite.js"></script>
  <style>
  </style>
  </head>
  <body>
  
   <div class="navbar navbar-default navbar-fixed-top" role="navigation">
        <div class="navbar-header">
          <a class="navbar-brand" href="#">Cow dashboard</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li class="active"><a href="#">Home</a></li>
            <li><a href="#sockets">Sockets</a></li>
            <li><a href="#tests">Tests</a></li>
          </ul>
        </div><!--/.nav-collapse -->
    </div>
    <div><!--STUPID!! --><br><br></div>

   <a id="sockets"></a>
   <div class="row">
    <div class="col-lg-2">
        <h2>Socket servers</h2>
        <ul id='socketservers' class="list-group"></ul>
        <h3>Add server</h3>
        <div class="input-group input-group-sm">
          <span class="input-group-addon">Prot.</span>
          <select id="newserverprot" class="form-control">
            <option>wss</option>
            <option selected>ws</option>
          </select>
        </div>
        <div class="input-group input-group-sm">
          <span class="input-group-addon">IP</span>
          <input id="newserverip" type="text" class="form-control" maxlength="15" size="15">
        </div>
        <div class="input-group input-group-sm">
          <span class="input-group-addon">Port</span>
          <input id="newserverport" type="text" class="form-control" maxlength="4" size="4">
          <span class="input-group-btn">
            <button class="btn btn-default" type="button" onclick="addserver();">Add</button>
          </span>
        </div><!-- /input-group -->
        <h3>Scan subnet</h3>
        <button class="btn btn-default" type="button" onclick="tests.socketsearch();">Scan!</button>
    </div>
    <div class="col-lg-2">
        <h2>Peers</h2>
        <ul id='peerlist' class="list-group"></ul>
    </div>
    <div class="col-lg-6">
        <h2>Console</h2>
        <div id="console" class="well"></div>
   </div>
   </div>
   </div><!-- /container -->
   
   <div class="container">
   <div class="row">
    <a id="tests"></a>
    <h2>Tests</h2>
    <div class="col-md-6">
        <div class="btn-group btn-group-justified">
        <div class="btn-group">
         <button type="button" class="btn btn-default btn-lg" onclick="clearlog()">Clear</button>
        </div>
        <div class="btn-group">
         <button type="button" class="btn btn-default btn-lg" onclick="tests.analyzeStore()">Analyze</button>
        </div>
        <div class="btn-group">     
         <button type="button" class="btn btn-default btn-lg" onclick="tests.pingtest()">Pingtest</button>
        </div>
        <div class="btn-group">
         <button type="button" class="btn btn-default btn-lg" onclick="tests.lifecycle()">Lifecycle</button>
        </div>
        <div class="btn-group">
         <button type="button" class="btn btn-default btn-lg" onclick="tests.socketservers()">Socketservers</button>
        </div>
       </div>
    </div>
   </div>
   
   
  
  <script type="text/javascript">
  
  var core = new Cow.core();
  //add a default socketserver
  core.socketservers({
    _id:'wss://websocket.geodan.nl:443/', 
    data: {protocol:'wss',ip:'websocket.geodan.nl', port:443}
  });
  
  function addserver(){
      var protocol = d3.select('#newserverprot')[0][0].value;
      var ip = d3.select('#newserverip')[0][0].value;
      var port = d3.select('#newserverport')[0][0].value;
      var url = protocol + '://' + ip + ':' + port + '/';
      core.socketservers({_id: url, data: {protocol: protocol, ip: ip, port: port}}).sync();
  }
  
  function reload_serverlist(){
      var serverlist = _.filter(core.socketservers(), function(d){return !d.deleted()});
          var servers = d3.select('#socketservers').selectAll('li')
            .data(serverlist, function(d){return d.id();});
          var newservers = servers.enter().append('li').classed("list-group-item",true);
          newservers.append('span').html(function(d){return d.url();})
            .on('click', function(d){
                    var ws = core.websocket();
                    ws.disconnect();
                    ws.connect(d.url());
                    reload_serverlist();
            });
          newservers.append('span').classed('input-group-btn',true)
            .on('click', function(d){console.log(d)});
          servers.exit().remove();
          servers.classed('active', function(d){
                if (d.url() == core.websocket()._url){
                    return true;
                }
                else {return false;}
          });
          servers.each(function(d){
                  var self = this;
                  var c = new WebSocket(d.url(), 'connect');
                  c.onopen = function(d){
                      d3.select(self).classed('list-group-item-success',true);
                      d3.select(self).classed('list-group-item-danger',false);
                      d.target.close();
                  }
                  c.onerror = function(d){
                      d3.select(self).classed('list-group-item-danger',true);;
                      d3.select(self).classed('list-group-item-success',false);
                  }
          });
  }
  function reload_peerlist(){
      var list = _.filter(core.peers(), function(d){return !d.deleted()});
      var items = d3.select('#peerlist').selectAll('li')
            .data(list, function(d){return d.id();});
          items.enter().append('li').classed("list-group-item",true)
            .html(function(d){return d.id();})
          items.exit().remove();
          items.classed('list-group-item-success', function(d){
              if (d.id() == core.peer().id()){
                        return true;
                    }
                    else {return false;}
          });
  }
  
  var connection = core.connect('wss://websocket.geodan.nl:443/');
  core.socketserverStore().loaded.then(reload_serverlist);
  core.socketserverStore().on('datachange', reload_serverlist);
  
  core.peerStore().loaded.then(reload_peerlist);
  core.peerStore().on('datachange', reload_peerlist);
  
  var tests = new Cow.testsuite(core);
  
  //tests.analyzeStore();
  //tests.lifecycle();
  
  
  </script>
  </body>
  </html>
