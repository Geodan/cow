/*! cow VERSION: 0.1.0 24-07-2014 */
window.Cow=window.Cow||{},Cow.utils={idgen:function(){return(new Date).getTime().toString()}};var array=[],push=array.push,slice=array.slice,splice=array.splice,Events={on:function(a,b,c){if(!eventsApi(this,"on",a,[b,c])||!b)return this;this._events||(this._events={});var d=this._events[a]||(this._events[a]=[]);return d.push({callback:b,context:c,ctx:c||this}),this},once:function(a,b,c){if(!eventsApi(this,"once",a,[b,c])||!b)return this;var d=this,e=_.once(function(){d.off(a,e),b.apply(this,arguments)});return e._callback=b,this.on(a,e,c)},off:function(a,b,c){var d,e,f,g,h,i,j,k;if(!this._events||!eventsApi(this,"off",a,[b,c]))return this;if(!a&&!b&&!c)return this._events=void 0,this;for(g=a?[a]:_.keys(this._events),h=0,i=g.length;i>h;h++)if(a=g[h],f=this._events[a]){if(this._events[a]=d=[],b||c)for(j=0,k=f.length;k>j;j++)e=f[j],(b&&b!==e.callback&&b!==e.callback._callback||c&&c!==e.context)&&d.push(e);d.length||delete this._events[a]}return this},trigger:function(a){if(!this._events)return this;var b=slice.call(arguments,1);if(!eventsApi(this,"trigger",a,b))return this;var c=this._events[a],d=this._events.all;return c&&triggerEvents(c,b),d&&triggerEvents(d,arguments),this},stopListening:function(a,b,c){var d=this._listeningTo;if(!d)return this;var e=!b&&!c;c||"object"!=typeof b||(c=this),a&&((d={})[a._listenId]=a);for(var f in d)a=d[f],a.off(b,c,this),(e||_.isEmpty(a._events))&&delete this._listeningTo[f];return this}},eventSplitter=/\s+/,eventsApi=function(a,b,c,d){if(!c)return!0;if("object"==typeof c){for(var e in c)a[b].apply(a,[e,c[e]].concat(d));return!1}if(eventSplitter.test(c)){for(var f=c.split(eventSplitter),g=0,h=f.length;h>g;g++)a[b].apply(a,[f[g]].concat(d));return!1}return!0},triggerEvents=function(a,b){var c,d=-1,e=a.length,f=b[0],g=b[1],h=b[2];switch(b.length){case 0:for(;++d<e;)(c=a[d]).callback.call(c.ctx);return;case 1:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f);return;case 2:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g);return;case 3:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g,h);return;default:for(;++d<e;)(c=a[d]).callback.apply(c.ctx,b)}},listenMethods={listenTo:"on",listenToOnce:"once"};_.each(listenMethods,function(a,b){Events[b]=function(b,c,d){var e=this._listeningTo||(this._listeningTo={}),f=b._listenId||(b._listenId=_.uniqueId("l"));return e[f]=b,d||"object"!=typeof c||(d=this),b[a](c,d,this),this}}),Events.bind=Events.on,Events.unbind=Events.off,window.Cow=window.Cow||{},Cow.record=function(){this._id=null,this._status="dirty",this._deleted=!1,this._created=(new Date).getTime(),this._updated=(new Date).getTime(),this._data={},this._deltaq={},this._deltas=[],this._deltasforupload=[]},Cow.record.prototype={sync:function(){var a=(new Date).getTime();return _(this._deltaq).size()>0&&!this._store.noDeltas&&this.deltas(a,this._deltaq),this._deltaq={},this._store.syncRecord(this)},id:function(){return this._id.toString()},created:function(){return this._created},timestamp:function(a){return a?(this._updated=a,this):this._updated},deleted:function(a){return void 0!==a?(this._deleted=a,this.timestamp((new Date).getTime()),this._status="dirty",this):this._deleted},status:function(a){return a?(this._status=a,this.timestamp((new Date).getTime()),this):this._status},data:function(a,b){return a?a&&"object"==typeof a&&!b?(this._data=a,this.status("dirty"),this):a&&"string"==typeof a&&!b?this._data[a]:a&&"number"==typeof a&&!b?this.data_on(a):a&&b?("object"==typeof b&&(b=JSON.parse(JSON.stringify(b))),this._data[a]=b,this._deltaq[a]=b,this.status("dirty"),this):void 0:"object"==typeof this._data?JSON.parse(JSON.stringify(this._data)):this._data},data_on:function(a){if(a<this._created)return null;if(a>this._updated)return this.data();var b={},c=_.sortBy(this.deltas(),function(a){return a.timestamp});return _.each(c,function(c){c.timestamp<=a&&_.extend(b,c.data)}),b},deltas:function(a,b){if(!a)return this._deltas;if(a&&!b){for(var c=0;c<this._deltas.length;c++)if(this._deltas[c].timestamp==a)return this._deltas[c];return null}if(a&&b){for(var d=!1,e=0;e<this._deltas.length;e++)this._deltas[e].timestamp==a&&(d=!0);return d||this._deltas.push({timestamp:a,data:b}),this}},deflate:function(){return{_id:this._id,status:this._status,created:this._created,deleted:this._deleted,updated:this._updated,data:this._data,deltas:this._deltas}},inflate:function(a){if(this._id=a._id||this._id,this._status=a.status||this._status,this._created=a.created||this._created,void 0!==a.deleted&&(this._deleted=a.deleted),this._updated=a.updated||this._updated,this._data=a.data||this._data||{},!this._store.noDeltas&&(this._deltaq=this._deltaq||{},this._deltasforupload=this._deltasforupload||{},this._deltas=this._deltas||[],a.deltas))for(var b=0;b<a.deltas.length;b++){var c=a.deltas[b].timestamp,d=a.deltas[b].data;this.deltas(c,d)}return this}},window.Cow=window.Cow||{},Cow.syncstore=function(a){var b=this;this._dbname=a.dbname,this._core=a.core,this.noDeltas=a.noDeltas||!1,this.maxStaleness=a.maxAge||null,this.syncinfo={toReceive:[],toSent:[],received:0,send:0},this.loaded=new Promise(function(c){a.noIDB?c():db.open({server:b._dbname,version:1,schema:{main:{key:{keyPath:"_id",autoIncrement:!1},indexes:{updated:{},_id:{unique:!0}}}}}).done(function(a){b._db=a,b._db_getRecords().then(function(a){a.forEach(function(a){var c=b._recordproto(a._id);c.inflate(a);for(var d=c.timestamp(),e=(new Date).getTime(),f=e-d,g=!1,h=0;h<b._records.length;h++)b._records[h]._id==c._id;!g&&(f<b.maxStaleness||null===b.maxStaleness)&&b._records.push(c)}),c()}).catch(function(a){console.warn(a.message)})})})},Cow.syncstore.prototype={_db_write:function(a){{var b=a.data;a.source}b._id=b._id.toString();var c=this._db;return new Promise(function(a,d){c.main.remove(b._id).done(function(){c.main.add(b).done(function(b){a(b)}).fail(function(a,b){d(b)})}).fail(function(a){console.warn(a),d(a)})})},_db_getRecords:function(){var a=this;return new Promise(function(b,c){a._db.main.query().filter().execute().done(function(a){b(a)}).fail(function(a){c(a)})})},_getRecords:function(a){for(var b=[],c=0;c<this._records.length;c++){var d=this._records[c];a.indexOf(d._id)>-1&&b.push(d)}return b},_getRecord:function(a){for(var b=0;b<this._records.length;b++){var c=this._records[b];if(c._id==a)return c}return null},_addRecord:function(a){if(!a.source||!a.data)return console.warn("Wrong input: ",a),!1;for(var b,c=null,d=a.source,e=a.data,f=!1,g=0;g<this._records.length;g++)this._records[g]._id==e._id&&(f=!0,b=this._records[g],b.inflate(e),this._db&&"WS"==d&&this._db_write({source:d,data:b.deflate()}));return f||(b=this._recordproto(e._id),b.inflate(e),this._db&&"WS"==d&&(c=this._db_write({source:d,data:b.deflate()})),this._records.push(b)),b},_getRecordsOn:function(a){var b=[];return _.each(this._records,function(c){a<c._created||(a>c._updated?b.push(c):c.data(a)&&b.push(c))}),b},records:function(a){return a&&Array.isArray(a)?this._getRecords(a):a&&"object"==typeof a?this._addRecord({source:"UI",data:a}).status("dirty"):a&&"string"==typeof a?this._getRecord(a):a&&"number"==typeof a?void 0:this._records},_removeRecord:function(a){for(var b=0;b<this._records.length;b++)if(this._records[b]._id==a)return this._records.splice(b,1),!0;return!1},clear:function(){var a=this;return new Promise(function(b){a._records=[],a.trigger("datachange"),a._db?a._db.main.clear().then(function(){b()}):b()})},deleteAll:function(){for(var a=0;a<this._records.length;a++)this._records[a].deleted(!0);return this.syncRecords(),this.trigger("datachange"),this},syncRecord:function(a){var b,c=this,d={};return d.syncType=this._type,a.status("clean"),this._projectid&&(d.project=this._projectid),b=this._db?this._db_write({source:"UI",data:a.deflate()}):new Promise(function(a){a()}),b.then(function(){d.record=a.deflate(),c.trigger("datachange"),c._core.websocket().sendData(d,"updatedRecord")},function(){}),a},syncRecords:function(){for(var a=[],b=0;b<this._records.length;b++){var c=this._records[b];"dirty"==c._status&&(c.status("clean"),a.push(c.deflate()))}var d={syncType:this._type,project:this._projectid,list:a};this._core.websocket().sendData(d,"requestedRecords")},deltaList:function(){},compareDeltas:function(){},sync:function(){var a=this;this.loaded.then(function(){var b={};b.syncType=a._type,b.project=a._projectid,b.list=a.idList(),a._core.websocket().sendData(b,"newList")}),a.loaded.catch(function(a){console.error(a.message)})},idList:function(){for(var a=[],b=0;b<this._records.length;b++){var c=this._records[b],d={};d._id=c._id,d.timestamp=c.timestamp(),d.deleted=c.deleted(),a.push(d)}return a},requestRecords:function(a){for(var b=[],c=0;c<this._records.length;c++){var d=this._records[c];for(j=0;j<a.length;j++){var e=a[j];e==d._id&&b.push(d.deflate())}}return b},compareRecords:function(a){var b=(a.uid,a.list),c={},d=[];c.requestlist=[],c.pushlist=[];var e;if(b){for(e=0;e<b.length;e++)d.push(b[e]._id);for(e=0;e<this._records.length;e++){for(var f=this._records[e],g=-1,h=0;h<b.length;h++){var i=b[h];if(i._id==f._id){g=1,i.timestamp<f._updated?c.pushlist.push(f.deflate()):i.timestamp>f._updated&&c.requestlist.push(i._id);var j=d.indexOf(f._id);j>=0&&d.splice(j,1)}}-1==g&&"true"!=f.deleted()&&c.pushlist.push(f.deflate())}}for(e=0;e<d.length;e++){var k=d[e];c.requestlist.push(k)}return c}},_.extend(Cow.syncstore.prototype,Events),window.Cow=window.Cow||{},Cow.peer=function(a){if(!a._id)throw"No _id given for peer";this._id=a._id,this._store=a.store,this._core=this._store._core,this._data={userid:null,family:"alpha"},this._status="dirty",this._deleted=!1,this._created=(new Date).getTime(),this._updated=(new Date).getTime(),this._deltaq={},this._deltas=[],this._deltasforupload=[]},Cow.peer.prototype={user:function(a){if(a)return this.data("userid",a).sync();if(this.data("userid")){var b=this.data("userid");return this._core.users(b)}return console.warn("No user connected to this peer"),null},username:function(){return this.user()?this.user().data("name"):"Anon"}},_.extend(Cow.peer.prototype,Cow.record.prototype),window.Cow=window.Cow||{},Cow.socketserver=function(a){if(!a._id)throw"No _id given for socketserver";this._id=a._id,this._store=a.store,this._core=this._store._core,this._data={protocol:null,ip:null,port:null,dir:null},this._status="dirty",this._deleted=!1,this._created=(new Date).getTime(),this._updated=(new Date).getTime(),this._deltaq={},this._deltas=[],this._deltasforupload=[]},Cow.socketserver.prototype={url:function(){var a=this.data("protocol"),b=this.data("ip"),c=this.data("port"),d=this.data("dir")||"";return a+"://"+b+":"+c+"/"+d}},_.extend(Cow.socketserver.prototype,Cow.record.prototype),window.Cow=window.Cow||{},Cow.user=function(a){if(!a._id)throw"No _id given for user";this._id=a._id,this._store=a.store,this._status="dirty",this._deleted=!1,this._created=(new Date).getTime(),this._updated=(new Date).getTime(),this._data={},this._deltaq={},this._deltas=[],this._deltasforupload=[]},Cow.user.prototype={name:function(a){return a?this.data("name",a):this.data("name")},mail:function(a){return a?this.data("mail",a):this.data("mail")},isActive:function(){for(var a=!1,b=this._store._core.peers(),c=0;c<b.length;c++)b[c].user()!=this._id||b[c].deleted()||(a=!0);return a},groups:function(){var a=this._store._core,b=[];if(!a.project())return console.warn("No active project"),null;for(var c=a.project().groups(),d=0;c.length;d++)c[d].hasMember(a.user().id())&&b.push(c[d]);return b},activeprojects:function(a,b){var c=this.data("activeprojects")||[];if(a&&b){var d=c.indexOf(a);return c.splice(d,1),this.data("activeprojects",c)}return a?(c.push(a),this.data("activeprojects",c)):this.data("activeprojects")||[]},mutedprojects:function(a,b){var c=this.data("mutedprojects")||[];if(a&&b){var d=c.indexOf(a);return c.splice(d,1),this.data("mutedprojects",c)}return a?(c.push(a),this.data("mutedprojects",c)):this.data("mutedprojects")||[]}},_.extend(Cow.user.prototype,Cow.record.prototype),window.Cow=window.Cow||{},Cow.group=function(a){if(!a._id)throw"No _id given for group";this._id=a._id,this._store=a.store,this._status="dirty",this._deleted=!1,this._created=(new Date).getTime(),this._updated=(new Date).getTime(),this._data={},this._deltaq={},this._deltas=[],this._deltasforupload=[]},Cow.group.prototype={members:function(a){var b=this;switch(arguments.length){case 0:return this._getMembers();case 1:if(Array.isArray(a)){if(Array.isArray(a)){for(var c=0;c<a.length;c++){var d=a[c];b._addMember(d)}return this}throw"Wrong input: "+a}return this._addMember(a),this;default:throw"wrong argument number"}},_getMembers:function(){return this.data("members")||[]},_addMember:function(a){for(var b=!1,c=this.members(),d=0;d<c.length;d++)c[d]==a&&(b=!0);return b||(c.push(a),this.data("members",c)),a},removeMember:function(a){for(var b=(this._store._core,this.members()),c=0;c<b.length;c++)if(b[c]==a)return b.splice(c,1),this.data("members",b),this},removeAllMembers:function(){var a=[];return this.data("members",a),this},groups:function(a){var b=this;switch(arguments.length){case 0:return this._getGroups();case 1:if(Array.isArray(a)){for(var c=0;c<a.length;c++){var d=a[c];b._addGroup(d)}return this._getGroups()}return this._addGroup(a);default:throw"wrong argument number"}},_getGroups:function(){return this.data("groups")||[]},_addGroup:function(a){for(var b=!1,c=this.groups(),d=0;d<this.groupList.length;d++)if(c[d]==a)return b=!0,a;return b||(c.push(a),this.data("groups",c)),a},removeGroup:function(a){for(var b=this.groups(),c=0;c<this.groupList.length;c++)if(b[c]==a)return b.splice(c,1),void self.data("groups",b)},removeAllGroups:function(){var a=[];this.data("groups",a)},hasMember:function(a){for(var b=!1,c=this.members(),d=0;d<c.length;d++)c[d]==a&&(b=!0);for(var e=[this._id],f=this.groups(),g=this._store._core,h=this._store._projectid,d=0;d<f.length;d++){var i=f[d].id;if(e.indexOf(i)<0){e.push(i);var j=g.projects(h).groups(i);b=j.hasMember(a)}}return b}},_.extend(Cow.group.prototype,Cow.record.prototype),window.Cow=window.Cow||{},Cow.item=function(a){if(!a||!a._id)throw"No _id given for item";this._id=a._id,this._store=a.store,this._status="dirty",this._deleted=!1,this._created=(new Date).getTime(),this._updated=(new Date).getTime(),this._data={},this._deltaq={},this._deltas=[],this._deltasforupload=[]},Cow.item.prototype={permissions:function(a,b){var c=this;switch(arguments.length){case 0:return c.data("permissions")||[];case 1:if("string"==typeof a)return c._permissionsByType(a);throw"type should be a string";case 2:if("string"==typeof a)return c._setPermission(a,b);throw"type should be a string";default:throw"wrong argument number"}},_permissionsByType:function(a){for(var b=this.permissions(),c=null,d=0;d<b.length;d++){var e=b[d];e.type==a&&(c=e)}return c},_setPermission:function(a,b){var c=this,d=this._permissionsByType(a),e=this.permissions();if(d)if(Array.isArray(b)||c.permissionHasGroup(a,b))for(var f=0;f<b.length;f++)c.permissionHasGroup(a,b[f])||d.groups.push(b[f]);else d.groups.push(b);else d=Array.isArray(b)?{type:a,groups:b}:{type:a,groups:[b]},e.push(d);return this.data("permissions",e),this},permissionHasGroup:function(a,b){var c=this.permissions(a),d=[];if(b&&Array.isArray(b)?d=b:b&&d.push(b),c){var e=c.groups;if(0===e.length)return!1;for(var f=!1,g=0;g<e.length;g++)for(var h=0;h<d.length;h++)e[g]==d[h]&&(f=!0);return f}return!1},hasPermission:function(a){var b=this._store._core,c=b.user().id(),d=b.projects(this._store._projectid),e=(d.groups(),!1),f=this.permissions(a);if(f)for(var g=0;g<f.groups.length;g++){var h=f.groups[g];void 0!==d.groups(h)&&d.groups(h).hasMember(c)&&(e=!0)}return e},removePermission:function(a,b){var c,d,e,f;switch(arguments.length){case 0:throw"this function doesn't take no arguments";case 1:if("string"==typeof a){for(c=null,e=this.permissions(),f=0;f<e.length;f++)d=e[f],d.type==a&&(c=f);return c>=0&&e.splice(c,1),this.data("permissions",e),this}throw"type should be a string";case 2:if("string"==typeof a){for(e=this.permissions(),f=0;f<e.length;f++)d=e[f],d.type==a&&(c=f);if(d=e[c]){var g=d.groups;if(g.length>=0)if(Array.isArray(b))for(f=0;f<b.length;f++){for(c=null,j=0;j<g.length;j++)g[j]==b[f]&&(c=j);c>=0&&g.splice(c,1)}else{for(c=null,f=0;f<g.length;f++)g[f]==b&&(c=f);c>=0&&g.splice(c,1)}d.groups=g,this.data("permissions",e)}return this}throw"type should be a string";default:throw"wrong argument number"}}},_.extend(Cow.item.prototype,Cow.record.prototype),window.Cow=window.Cow||{},Cow.project=function(a){var b=this;if(!a._id)throw"No _id given for project";this._id=a._id,this._store=a.store,this._core=this._store._core,this._status="dirty",this._deleted=!1,this._created=(new Date).getTime(),this._updated=(new Date).getTime(),this._data={},this._deltaq={},this._deltas=[],this._deltasforupload=[];var c="groups_"+a._id;this._groupStore=_.extend(new Cow.syncstore({dbname:c,core:b._core}),{_records:[],_recordproto:function(a){return new Cow.group({_id:a,store:this})},_type:"groups",_dbname:c,_projectid:this._id,dbname:function(a){this._dbname=a}}),c="items_"+a._id,this._itemStore=_.extend(new Cow.syncstore({dbname:c,core:b._core}),{_recordproto:function(a){return new Cow.item({_id:a,store:this})},_projectid:this._id,_records:[],_type:"items",_dbname:c,dbname:function(a){this._dbname=a}})},Cow.project.prototype={closed:function(a){if(void 0!==a){this._closed=a;var b=this.deflate();return b.closed=this._closed,this._store._db_write({source:"UI",data:b}),this}return this._closed},groupStore:function(){return this._groupStore},groups:function(a){return this._groupStore.records(a)},itemStore:function(){return this._itemStore},items:function(a){return this._itemStore.records(a)},myGroups:function(){for(var a=this.groups(),b=this._core.user().id(),c=[],d=0;d<a.length;d++){var e=a[d];e.hasMember(b)&&c.push(e.id())}return c}},_.extend(Cow.project.prototype,Cow.record.prototype),window.Cow=window.Cow||{},Cow.websocket=function(a){this._core=a.core,this._url=a.url,this._connection=null},Cow.websocket.prototype.disconnect=function(){this._connection?(this._connection.close(),this._connection=null):console.log("No websocket active")},Cow.websocket.prototype.connect=function(a){var b=this._core;if(this._url=b.socketservers(a).url(),b._socketserverid=a,!this._url)throw"Nu URL given to connect to. Make sure you give a valid socketserver id as connect(id)";if(this._connection&&1==this._connection.readyState)c=this._connection;else{if(0!==this._url.indexOf("ws"))throw"Incorrect URL: "+this._url;var c=new WebSocket(this._url,"connect");c.onopen=this._onOpen,c.onmessage=this._onMessage,c.onclose=this._onClose,c.onerror=this._onError,c.obj=this,this._connection=c}return c},Cow.websocket.prototype.connection=function(){return this._connection},Cow.websocket.prototype.sendData=function(a,b,c){var d={};d.sender=this._core.peerid(),d.target=c,d.action=b,d.payload=a;var e;try{e=JSON.stringify(d)}catch(f){console.error(f,d)}this._connection&&1==this._connection.readyState&&this._connection.send(JSON.stringify(d))},Cow.websocket.prototype._onMessage=function(a){var b=this.obj._core,c=JSON.parse(a.data),d=c.sender,e=b.peerid(),f=c.action,g=c.payload,h=c.target;switch(f){case"command":d!=e&&this.obj._onCommand(c);break;case"connected":this.obj._onConnect(g);break;case"peerGone":this.obj._onPeerGone(g);break;case"newList":d!=e&&this.obj._onNewList(g,d);break;case"syncinfo":d!=e&&this.obj._onSyncinfo(g,d);break;case"wantedList":h==e&&this.obj._onWantedList(g);break;case"missingRecords":h==e&&this.obj._onMissingRecords(g);break;case"requestedRecords":d!=e&&this.obj._onMissingRecords(g);break;case"updatedRecord":d!=e&&this.obj._onUpdatedRecords(g)}},Cow.websocket.prototype._onClose=function(a){a.code,a.reason,a.wasClean;this.obj._core.peerStore().clear()},Cow.websocket.prototype._onConnect=function(a){var b=this;this._core.peerid(a.peerID);var c=this._core.peers({_id:a.peerID}),d=(a.server_version,a.server_key);if("test"!=d)return void b.disconnect();this._core.user()&&c.data("userid",this._core.user()._id),c.deleted(!1).sync(),this.trigger("connected",a),this._core.socketserverStore().sync(),this._core.peerStore().sync(),this._core.userStore().sync();var e=this._core.projectStore();e.sync(),e.loaded.then(function(){for(var a=b._core.projects(),c=0;c<a.length;c++){var d=a[c];b._core.projects(d._id).itemStore().sync(),b._core.projects(d._id).groupStore().sync()}})},Cow.websocket.prototype._onPeerGone=function(a){var b=a.gonePeerID.toString();this._core.peers(b)&&this._core.peers(b).deleted(!0).sync()},Cow.websocket.prototype._onError=function(a){console.warn("error in websocket connection: "+a.type)},Cow.websocket.prototype._getStore=function(a){var b,c=a.syncType,d=a.project;switch(c){case"peers":return this._core.peerStore();case"socketservers":return this._core.socketserverStore();case"projects":return this._core.projectStore();case"users":return this._core.userStore();case"items":if(!d)throw"No project id given";return b=this._core.projects(this._core.projects(d)?d:{_id:d}),b.itemStore();case"groups":if(!d)throw"No project id given";return b=this._core.projects(this._core.projects(d)?d:{_id:d}),b.groupStore()}},Cow.websocket.prototype._onNewList=function(a,b){var c=this;if(this._amIAlpha()){var d,e=this._getStore(a),f=e._projectid,g=e.compareRecords({uid:b,list:a.list}),h={IWillSent:_.pluck(g.pushlist,"_id"),IShallReceive:_.pluck(g.requestlist,"_id")};d={syncType:a.syncType,project:f,syncinfo:h},this.sendData(d,"syncinfo",b),d={syncType:a.syncType,project:f,list:g.requestlist},this.sendData(d,"wantedList",b),d={syncType:a.syncType,project:f,list:g.pushlist},_(d.list).each(function(d){msg={syncType:a.syncType,project:f,record:d},c.sendData(msg,"updatedRecord",b)})}},Cow.websocket.prototype._amIAlpha=function(){var a=null,b=_.sortBy(_.filter(this._core.peers(),function(a){return"alpha"==a.data("family")&&!a.deleted()}),function(a){return a.created()}),c=b[0],d=this._core.peer();return a=d.created()==c.created()?!0:!1},Cow.websocket.prototype._onSyncinfo=function(a){var b=this._getStore(a);b.syncinfo.toReceive=a.syncinfo.IWillSent,b.syncinfo.toSent=a.syncinfo.IShallReceive},Cow.websocket.prototype._onWantedList=function(a){var b=this,c=this._getStore(a),d=c.requestRecords(a.list),e={syncType:a.syncType,project:c._projectid,list:d};_(e.list).each(function(d){msg={syncType:a.syncType,project:c._projectid,record:d},b.sendData(msg,"updatedRecord")})},Cow.websocket.prototype._onMissingRecords=function(a){var b,c=this._getStore(a),d=a.list,e=[];for(b=0;b<d.length;b++){var f=d[b],g=c._addRecord({source:"WS",data:f});if("projects"==c._type&&(g.groupStore().sync(),g.itemStore().sync()),f.deltas&&g.deltas()){var h=_.pluck(g.deltas(),"timestamp"),i=_.pluck(f.deltas,"timestamp"),j=_.difference(h,i);j.length>0&&e.push(g)}}for(b=0;b<e.length;b++)c.syncRecord(e[b]);c.trigger("datachange")},Cow.websocket.prototype._onUpdatedRecords=function(a){var b=this._getStore(a),c=a.record;b._addRecord({source:"WS",data:c}),b.syncinfo.toReceive=_.without(b.syncinfo.toReceive,c._id),b.trigger("datachange")},Cow.websocket.prototype._onCommand=function(a){{var b=this._core,c=a.payload,d=c.command,e=c.targetuser;c.params}if(this.trigger("command",a),"zoomTo"==d&&e&&e==b.user().id()&&this.trigger(d,c.location),"kickPeer"==d&&e&&e==b.peerid()&&(window.open("","_self",""),window.close()),"purgePeer"==d&&e&&e==this._core.peerid()&&(_.each(b.projects(),function(a){a.itemStore().clear(),a.groupStore().clear()}),b.projectStore().clear(),b.userStore().clear()),"flushProject"==d){var f,g=c.projectid;b.projects(g)&&(f=b.projects(g),f.itemStore().clear(),f.itemStore()._db.main.clear())}if("ping"==d){var h=a.sender;this.sendData({command:"pong"},"command",h)}},_.extend(Cow.websocket.prototype,Events),Cow.core=function(){var a=this;this._userid=null,this._socketserverid=null,this._projectid=null,this._wsUrl=null,this._peerid=null,this._maxAge=2592e6,this._websocket=new Cow.websocket({url:this._wsUrl,core:this}),this._projectStore=_.extend(new Cow.syncstore({dbname:"projects",noDeltas:!0,core:a}),{_records:[],_recordproto:function(a){return new Cow.project({_id:a,store:this})},_dbname:"projects",_type:"projects"}),this._peerStore=_.extend(new Cow.syncstore({dbname:"peers",noIDB:!0,noDeltas:!0,core:this}),{_records:[],_recordproto:function(a){return new Cow.peer({_id:a,store:this})},_dbname:"peers",_type:"peers",removePeer:function(a){return this._removeRecord(a)}}),Object.observe(this._peerStore._records,function(){console.log("peerchange"),this.trigger("datachange")}),this._userStore=_.extend(new Cow.syncstore({dbname:"users",noDeltas:!0,core:this}),{_records:[],_recordproto:function(a){return new Cow.user({_id:a,store:this})},_dbname:"users",_type:"users"}),this._socketserverStore=_.extend(new Cow.syncstore({dbname:"socketservers",noDeltas:!0,core:this,maxAge:this.maxAge}),{_records:[],_recordproto:function(a){return new Cow.socketserver({_id:a,store:this})},_dbname:"socketservers",_type:"socketservers"})},Cow.core.prototype={peerid:function(a){return a?(this._peerid=a.toString(),this._peerid):this._peerid?this._peerid.toString():null},project:function(a){if(a){a=a.toString();var b=this.projects(a);return b?(this._projectid=a,this.peer()&&this.peer().data("activeproject",a).sync(),this.trigger("projectChanged"),!0):(console.warn("Trying to select a non existing project"),!1)}return this._projectid?this.projects(this._projectid):!1},user:function(a){return a?(a=a.toString(),this._userid=a,this.peerid()&&this.peers(this.peerid()).data("userid",a).sync(),this.users(a).data("name",a)):this._userid?this.users(this._userid):!1},socketserver:function(){return this._socketserverid?this.socketservers(this._socketserverid):!1},peer:function(){return this.peerid()?this.peers(this.peerid()):!1},location:function(a){return a?(this._location=a,this.peerid()&&this.peers(this.peerid()).data("location",a).sync(),this._location):this._location},projectStore:function(){return this._projectStore},projects:function(a){return this._projectStore.records(a)},peerStore:function(){return this._peerStore},peers:function(a){return this._peerStore.records(a)},socketserverStore:function(){return this._socketserverStore},socketservers:function(a){return this._socketserverStore.records(a)},userStore:function(){return this._userStore},users:function(a){return this._userStore.records(a)},activeUsers:function(){for(var a=[],b=this.users(),c=0;c<b.length;c++)b[c].isActive()&&a.push(b[c]);return a},websocket:function(){return this._websocket},connect:function(a){return this._websocket.connect(a)}},_.extend(Cow.core.prototype,Events);