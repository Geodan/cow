/*! cow VERSION: 2.2.5 18-08-2016 */
function lzw_encode(a){for(var b,c={},d=(a+"").split(""),e=[],f=d[0],g=256,h=1;h<d.length;h++)b=d[h],null!=c[f+b]?f+=b:(e.push(f.length>1?c[f]:f.charCodeAt(0)),c[f+b]=g,g++,f=b);e.push(f.length>1?c[f]:f.charCodeAt(0));for(var h=0;h<e.length;h++)e[h]=String.fromCharCode(e[h]);return e.join("")}function lzw_decode(a){for(var b,c={},d=(a+"").split(""),e=d[0],f=e,g=[e],h=256,i=1;i<d.length;i++){var j=d[i].charCodeAt(0);b=256>j?d[i]:c[j]?c[j]:f+e,g.push(b),e=b.charAt(0),c[h]=f+e,h++,f=b}return g.join("")}function encode_utf8(a){return unescape(encodeURIComponent(a))}function decode_utf8(a){try{return decodeURIComponent(escape(a))}catch(b){console.warn(b,a)}}(function(){var a=[],b=(a.push,a.slice),c=(a.splice,{on:function(a,b,c){if(!e(this,"on",a,[b,c])||!b)return this;this._events||(this._events={});var d=this._events[a]||(this._events[a]=[]);return d.push({callback:b,context:c,ctx:c||this}),this},once:function(a,b,c){if(!e(this,"once",a,[b,c])||!b)return this;var d=this,f=_.once(function(){d.off(a,f),b.apply(this,arguments)});return f._callback=b,this.on(a,f,c)},off:function(a,b,c){var d,f,g,h,i,j,k,l;if(!this._events||!e(this,"off",a,[b,c]))return this;if(!a&&!b&&!c)return this._events=void 0,this;for(h=a?[a]:_.keys(this._events),i=0,j=h.length;j>i;i++)if(a=h[i],g=this._events[a]){if(this._events[a]=d=[],b||c)for(k=0,l=g.length;l>k;k++)f=g[k],(b&&b!==f.callback&&b!==f.callback._callback||c&&c!==f.context)&&d.push(f);d.length||delete this._events[a]}return this},trigger:function(a){if(!this._events)return this;var c=b.call(arguments,1);if(!e(this,"trigger",a,c))return this;var d=this._events[a],g=this._events.all;return d&&f(d,c),g&&f(g,arguments),this},stopListening:function(a,b,c){var d=this._listeningTo;if(!d)return this;var e=!b&&!c;c||"object"!=typeof b||(c=this),a&&((d={})[a._listenId]=a);for(var f in d)a=d[f],a.off(b,c,this),(e||_.isEmpty(a._events))&&delete this._listeningTo[f];return this}}),d=/\s+/,e=function(a,b,c,e){if(!c)return!0;if("object"==typeof c){for(var f in c)a[b].apply(a,[f,c[f]].concat(e));return!1}if(d.test(c)){for(var g=c.split(d),h=0,i=g.length;i>h;h++)a[b].apply(a,[g[h]].concat(e));return!1}return!0},f=function(a,b){var c,d=-1,e=a.length,f=b[0],g=b[1],h=b[2];switch(b.length){case 0:for(;++d<e;)(c=a[d]).callback.call(c.ctx);return;case 1:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f);return;case 2:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g);return;case 3:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g,h);return;default:for(;++d<e;)(c=a[d]).callback.apply(c.ctx,b)}},g={listenTo:"on",listenToOnce:"once"};_.each(g,function(a,b){c[b]=function(b,c,d){var e=this._listeningTo||(this._listeningTo={}),f=b._listenId||(b._listenId=_.uniqueId("l"));return e[f]=b,d||"object"!=typeof c||(d=this),b[a](c,d,this),this}}),c.bind=c.on,c.unbind=c.off;var h=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=c),exports.Events=c):h.Events=c}).call(this);var Cow={};(function(){var a=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=Cow||{}),exports.Cow=Cow||{}):(a.Cow=Cow||{},a._=_),Cow.utils={idgen:function(){return"ID"+(1e16*Math.random()).toString()}}}).call(this),function(){var a=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=Cow||{}),exports.Cow=Cow||{}):a.Cow=Cow||{},Cow.record=function(){this._id=(new Date).getTime().toString(),this._dirty=!1,this._ttl=null,this._deleted=!1,this._created=(new Date).getTime(),this._updated=(new Date).getTime(),this._data={},this._deltaq={},this._deltas=[],this._deltasforupload=[]},Cow.record.prototype={sync:function(){if(this._dirty){var a=(new Date).getTime(),b=this._store._core.user()?this._store._core.user().id():null;return this._dirty&&!this._store.noDeltas&&this.deltas(a,this._deltaq,this._deleted,b),this._deltaq={},this._store.syncRecord(this)}return console.log("Not syncing because record not dirty"),this},id:function(a){return a&&console.warn("You can't set an id afterwards, that only happens when object is created (ignoring)"),this._id.toString()},created:function(a){return a&&console.warn("You can't set creation date afterwards. (ignoring)"),this._created},creator:function(){var a;return this._deltas.length>0&&this._deltas[0].userid&&(a=this._store._core.users(this._deltas[0].userid.toString())),a},updater:function(a){if(a)return this.updater_on(a);if(this._deltas.length>0&&this._deltas[this._deltas.length-1].userid){var b=this._deltas[this._deltas.length-1].userid;return this._store._core.users(b.toString())}return null},updated:function(a){return a?(this._updated=a,this):this._updated},touch:function(){return this.updated((new Date).getTime()),this._dirty=!0,this},deleted:function(a){return void 0!==a&&"boolean"==typeof a?(this._deleted!==a&&(this._deleted=a,this.updated((new Date).getTime()),this._dirty=!0),this):void 0!==a&&"number"==typeof a?this.deleted_on(a):this._deleted},dirty:function(a){return void 0!==a?(this._dirty!==a&&(this._dirty=a,this.updated((new Date).getTime())),this):this._dirty},ttl:function(a){return void 0!==a?(this._ttl!==a&&(this._ttl=a),this):this._ttl},expired:function(){var a=(new Date).getTime()-this.updated();return!!(this._ttl&&a>this._ttl)},data:function(a,b){return a?a&&"object"==typeof a&&!b?(this._data=a,this._deltaq=a,this.dirty(!0),this):a&&"string"==typeof a&&"undefined"==typeof b?this._data[a]:a&&"number"==typeof a&&"undefined"==typeof b?this.data_on(a):a&&"undefined"!=typeof b?("object"==typeof b&&(b=JSON.parse(JSON.stringify(b))),this._data[a]!=b&&(this._data[a]=b,this._deltaq[a]=b,this.dirty(!0)),this):void 0:"object"==typeof this._data?JSON.parse(JSON.stringify(this._data)):this._data},data_on:function(a){if(a<this._created)return null;if(a>this._updated)return this.data();var b={},c=_.sortBy(this.deltas(),function(a){return a.timestamp});return c.forEach(function(c){c.timestamp<=a&&_.extend(b,c.data)}),b},deleted_on:function(a){if(a<this._created)return null;if(a>this._updated)return this.deleted();var b={},c=_.sortBy(this.deltas(),function(a){return a.timestamp});return c.forEach(function(c){c.timestamp<=a&&(b=c.deleted)}),b},updater_on:function(a){if(a<this._created)return null;if(a>this._updated)return this.updater();var b=_.sortBy(this.deltas(),function(a){return a.timestamp});return b.forEach(function(b){b.timestamp<=a}),null},deltas:function(a,b,c,d){if(!a)return this._deltas.sort(function(a,b){return a.timestamp-b.timestamp});if(a&&!b){for(var e=0;e<this._deltas.length;e++)if(this._deltas[e].timestamp==a)return this._deltas[e];return null}if(a&&b){for(var f=!1,g=0;g<this._deltas.length;g++)this._deltas[g].timestamp==a&&(f=!0);return f||this._deltas.push({timestamp:a,data:b,userid:d,deleted:c}),this}},deflate:function(){return{_id:this._id,dirty:this._dirty,ttl:this._ttl,created:this._created,deleted:this._deleted,updated:this._updated,data:this._data,deltas:this._deltas}},inflate:function(a){if(this._id=a._id||this._id,void 0!==a.dirty&&(this._dirty=a.dirty),this._ttl=a.ttl||this._ttl,this._created=a.created||this._created,void 0!==a.deleted&&(this._deleted=a.deleted),this._updated=a.updated||this._updated,this._data=a.data||this._data||{warn:"empty inflate"},!this._store.noDeltas&&(this._deltaq=this._deltaq||{},this._deltasforupload=this._deltasforupload||{},this._deltas=this._deltas||[],a.deltas))for(var b=0;b<a.deltas.length;b++){var c=a.deltas[b].timestamp,d=a.deltas[b].data,e=a.deltas[b].deleted,f=a.deltas[b].userid;this.deltas(c,d,e,f)}return this}},_.extend(Cow.record.prototype,Events)}.call(this),function(){var a=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=Cow||{}),exports.Cow=Cow||{}):"undefined"==typeof Cow?a.Cow={}:a.Cow=Cow,Cow.localdb=function(a){var b=this;this._dbname=a.dbname,this._core=a.core,this._db=null;var c=2;this._openpromise=new Promise(function(a,d){var e=indexedDB.open(b._dbname,c);e.onupgradeneeded=function(a){console.log("Indexeddb initialized/upgraded");var b=a.target.result;b.objectStoreNames.contains("users")&&b.deleteObjectStore("users"),b.objectStoreNames.contains("projects")&&b.deleteObjectStore("projects"),b.objectStoreNames.contains("socketservers")&&b.deleteObjectStore("socketservers"),b.objectStoreNames.contains("items")&&b.deleteObjectStore("items"),b.objectStoreNames.contains("groups")&&b.deleteObjectStore("groups"),b.createObjectStore("users",{keyPath:"_id"}),b.createObjectStore("projects",{keyPath:"_id"}),b.createObjectStore("socketservers",{keyPath:"_id"}),b.createObjectStore("items",{keyPath:"_id"}).createIndex("projectid","projectid",{unique:!1}),b.createObjectStore("groups",{keyPath:"_id"}).createIndex("projectid","projectid",{unique:!1})},e.onsuccess=function(c){b._db=c.target.result,a()}})},Cow.localdb.prototype.write=function(a){var b=this,c=a.storename,d=a.data,e=a.projectid;d._id=d._id.toString(),d.projectid=e;var f=new Promise(function(a,e){var f=b._db.transaction([c],"readwrite");f.onabort=function(a){console.warn("Abort error")};var g=f.objectStore(c),h=g.put(d);h.onsuccess=function(b){a(h.result)},h.onerror=function(a){console.warn("IDB Error: ",a.value),e("Couldn't add the passed item")}});return f},Cow.localdb.prototype.writeAll=function(a){var b=this,c=a.storename,d=a.data,e=a.projectid,f=new Promise(function(a,f){var g=b._db.transaction([c],"readwrite");g.onabort=function(a){console.warn("Abort error"),f()};for(var h=g.objectStore(c),i=0;i<d.length;i++){var j=d[i];j._id=j._id.toString(),j.projectid=e;var k=h.put(j);k.onsuccess=function(a){},k.onerror=function(a){console.warn("IDB Error: ",a.value),f("Couldn't add the passed item")}}a()});return f},Cow.localdb.prototype.getRecord=function(a){var b=this,c=a.storename,d=a.id,e=new Promise(function(a,e){var f=b._db.transaction([c]);f.onabort=function(a){console.warn("Abort error")};var g=f.objectStore(c),h=g.get(d);h.onsuccess=function(){a(h.result)},h.onerror=function(a){console.warn("IDB Error: ",a.value),e(a)}});return e},Cow.localdb.prototype.getRecords=function(a){var b,c,d=a.storename,e=a.projectid,f=this._db.transaction([d]);f.onabort=function(a){console.warn("Abort error")};var g=f.objectStore(d);e?(b=IDBKeyRange.only(e),c=g.index("projectid")):c=g;var h=new Promise(function(a,d){var e,f=[];e=b?c.openCursor(b):c.openCursor(),e.onsuccess=function(b){var c=b.target.result;c?(f.push(c.value),c["continue"]()):a(f)},e.onerror=function(a){console.warn("IDB Error: ",a.value),d(a)}});return h},Cow.localdb.prototype.delRecord=function(a){var b=this,c=a.storename,d=(a.projectid,a.id),e=new Promise(function(a,e){var f=b._db.transaction([c],"readwrite");f.onabort=function(a){console.warn("Abort error")};var g=f.objectStore(c),h=g["delete"](d);h.onsuccess=function(b){a()},h.onerror=function(a){console.warn("IDB Error: ",a.value),e(a)}});return e},Cow.localdb.prototype.clear=function(a){var b,c,d=a.storename,e=a.projectid,f=this._db.transaction([d],"readwrite");f.onabort=function(a){console.warn("Abort error")};var g=f.objectStore(d);e?(b=IDBKeyRange.only(e),c=g.index("projectid")):c=g;var h=new Promise(function(a,d){var e;e=b?c.openCursor(b):c.openCursor(),e.onsuccess=function(b){var c=b.target.result;c?(g["delete"](c.primaryKey),c["continue"]()):a()},e.onerror=function(a){console.warn("IDB Error: ",a.value),d(a)}});return h}}.call(this),function(){var a=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=Cow||{}),exports.Cow=Cow||{}):a.Cow=Cow||{},Cow.syncstore=function(a){var b=this;this._storename=a.dbname,this._isloaded=!1,this._core=a.core,this.noDeltas=a.noDeltas||!1,this.noIDB=a.noIDB||!1,this._maxAge=a.maxAge,this.syncinfo={toReceive:[],toSent:[],received:0,send:0},this.noIDB||(this.localdb=this._core.localdb(),this._commitqueue={storename:this._storename,projectid:this._projectid,data:[]}),this.loaded=new Promise(function(a,c){b.localdb?b._core.dbopen().then(function(){b.localdb.getRecords({storename:b._storename,projectid:b._projectid}).then(function(c){c.forEach(function(a){var c=b._recordproto(a._id);c.inflate(a);for(var d=c.updated(),e=(new Date).getTime(),f=e-d,g=!1,h=0;h<b._records.length;h++)b._records[h]._id==c._id&&(g=!0);!g&&(f<=c._ttl||null===b._ttl)&&b._records.push(c),c._ttl&&f>c._ttl&&b.localdb.delRecord({storename:b._storename,projectid:b._projectid,id:c._id})}),b.trigger("datachange"),b._isloaded=!0,a()},function(a){console.warn("DB Fail"),c(a)})},function(a){console.warn("DB Fail"),c(a)}):(b._isloaded=!0,a())}),this.synced=new Promise(function(a,c){b.loaded.then(function(){b.on("synced",function(){a()})}),b.loaded["catch"](function(a){console.error(a.message),c()})})},Cow.syncstore.prototype={_loadFromDb:function(){var a=this;return new Promise(function(b,c){a.localdb.getRecords({storename:a._storename,projectid:a._projectid}).then(function(c){c.forEach(function(b){var c=a._recordproto(b._id);c.inflate(b);for(var d=c.updated(),e=(new Date).getTime(),f=e-d,g=!1,h=0;h<a._records.length;h++)a._records[h]._id==c._id&&a._records[h]._updated<c._updated?(a._records.splice(h,1,c),g=!0):a._records[h]._id==c._id&&a._records[h]._updated>=c._updated&&(g=!0);!g&&(f<=c._ttl||null===c._ttl)?a._records.push(c):c._ttl&&f>c._ttl&&a.localdb.delRecord({storename:a._storename,projectid:a._projectid,id:c._id})}),a.trigger("datachange"),b()},function(a){console.warn("DB Fail"),c(a)})})},_getRecords:function(a){for(var b=[],c=0;c<this._records.length;c++){var d=this._records[c];a.indexOf(d._id)>-1&&b.push(d)}return b},_getRecord:function(a){for(var b=0;b<this._records.length;b++){var c=this._records[b];if(c._id==a)return c}return null},_addRecord:function(a){if(!a.source||!a.data)return console.warn("Wrong input: "+a),!1;for(var b,c=a.source,d=a.data,e=!1,f=0;f<this._records.length;f++)this._records[f]._id==d._id&&(e=!0,b=this._records[f],b.inflate(d),this.localdb&&"WS"==c&&this._commitqueue.data.push(b.deflate()));return e||(b=this._recordproto(d._id),b.inflate(d),this.localdb&&"WS"==c&&this._commitqueue.data.push(b.deflate()),this._records.push(b)),b.trigger("datachange"),b},_commit:function(){!this.noIDB&&this._commitqueue.data.length>0&&(this._commitqueue.projectid=this._projectid,this.localdb.writeAll(this._commitqueue),this._commitqueue.data=[])},_getRecordsOn:function(a){var b=[];return this._records.forEach(function(c){a<c._created||(a>=c._updated?b.push(c):c.data(a)&&b.push(c))}),b},records:function(a){return a&&Array.isArray(a)?this._getRecords(a):a&&"object"==typeof a?this._addRecord({source:"UI",data:a}).dirty(!0):a&&"string"==typeof a?this._getRecord(a):a&&"number"==typeof a?this._getRecordsOn(a):this._records},_removeRecord:function(a){for(var b=0;b<this._records.length;b++)if(this._records[b]._id==a)return this._records.splice(b,1),!0;return!1},clear:function(){var a=this;return new Promise(function(b,c){a._records=[],a.trigger("datachange"),a.localdb?a.localdb.clear({storename:a._storename,projectid:a._projectid}).then(function(){b()}):b()})},deleteAll:function(){for(var a=0;a<this._records.length;a++)this._records[a].deleted(!0).sync();return this},pruneDeleted:function(){var a=this;this._records.filter(function(a){return a.deleted()}).forEach(function(b){a._removeRecord(b.id()),a.localdb&&a.localdb.delRecord({storename:a._storename,projectid:a._projectid,id:b.id()})})},syncRecord:function(a){var b,c=this,d={};return d.syncType=this._type,a.dirty(!1),this._projectid&&(d.project=this._projectid),b=this.localdb?this.localdb.write({storename:this._storename,projectid:this._projectid,data:a.deflate()}):new Promise(function(a,b){a()}),b.then(function(b){d.record=a.deflate(),c.trigger("datachange"),c._core.messenger().sendData(d,"updatedRecord")},function(a){console.warn(a)}),a},deltaList:function(){},compareDeltas:function(){},sync:function(){var a=this;a.loaded.then(function(b){var c={};c.syncType=a._type,c.project=a._projectid,c.list=a.idList(),a._core.messenger().sendData(c,"newList")}),a.loaded["catch"](function(a){console.error(a.message),reject()})},idList:function(){for(var a=[],b=0;b<this._records.length;b++){var c=this._records[b],d={};d._id=c._id,d.timestamp=c.updated(),d.updated=c.updated(),d.deleted=c.deleted(),a.push(d)}return a},requestRecords:function(a){for(var b=[],c=0;c<this._records.length;c++){var d=this._records[c];for(j=0;j<a.length;j++){var e=a[j];e==d._id&&b.push(d.deflate())}}return b},compareRecords:function(a){var b=(a.uid,a.list),c={},d=[];c.requestlist=[],c.pushlist=[];var e;if(b){for(e=0;e<b.length;e++)d.push(b[e]._id);for(e=0;e<this._records.length;e++){for(var f=this._records[e],g=-1,h=0;h<b.length;h++){var i=b[h];if(i._id==f._id){g=1,i.updated||(i.updated=i.timestamp),i.updated<f._updated?c.pushlist.push(f.deflate()):i.updated>f._updated&&c.requestlist.push(i._id);var j=d.indexOf(f._id);j>=0&&d.splice(j,1)}}-1!=g||f.deleted()||f.expired()||c.pushlist.push(f.deflate())}}for(e=0;e<d.length;e++){var k=d[e];c.requestlist.push(k)}return c}},_.extend(Cow.syncstore.prototype,Events)}.call(this),function(){var a=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=Cow||{}),exports.Cow=Cow||{}):a.Cow=Cow||{},Cow.peer=function(a){this._id=a._id||Cow.utils.idgen(),this._store=a.store,this._core=this._store._core,this._data={userid:null,family:"alpha"},this._dirty="true",this._ttl=this._store._maxAge,this._deleted=!1,this._created=(new Date).getTime(),this._updated=(new Date).getTime(),this._deltaq={},this._deltas=[],this._deltasforupload=[]},Cow.peer.prototype={user:function(a){if(a)return this.data("userid",a).sync();if(this.data("userid")){var b=this.data("userid");return this._core.users(b)}return null},username:function(){return this.user()?this.user().data("name"):null}},_.extend(Cow.peer.prototype,Cow.record.prototype)}.call(this),function(){var a=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=Cow||{}),exports.Cow=Cow||{}):a.Cow=Cow||{},Cow.socketserver=function(a){this._id=a._id||Cow.utils.idgen(),this._store=a.store,this._core=this._store._core,this._maxAge=this._core._maxAge,this._dirty=!0,this._ttl=this._store._maxAge,this._deleted=!1,this._created=(new Date).getTime(),this._updated=(new Date).getTime(),this._data={protocol:null,ip:null,port:null,dir:null},this._deltaq={},this._deltas=[],this._deltasforupload=[]},Cow.socketserver.prototype={url:function(){var a=this.data("protocol"),b=this.data("ip"),c=this.data("port"),d=this.data("dir")||"";return a+"://"+b+":"+c+"/"+d}},_.extend(Cow.socketserver.prototype,Cow.record.prototype)}.call(this),function(){var a=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=Cow||{}),exports.Cow=Cow||{}):a.Cow=Cow||{},Cow.user=function(a){this._id=a._id||Cow.utils.idgen(),this._store=a.store,this._dirty=!0,this._ttl=this._store.maxStaleness,this._deleted=!1,this._created=(new Date).getTime(),this._updated=(new Date).getTime(),this._data={},this._deltaq={},this._deltas=[],this._deltasforupload=[]},Cow.user.prototype={isActive:function(){for(var a=!1,b=this._store._core.peers(),c=0;c<b.length;c++)b[c].user()!=this._id||b[c].deleted()||(a=!0);return a},groups:function(){var a=this._store._core,b=[];if(!a.project())return console.warn("No active project"),null;for(var c=a.project().groups(),d=0;c.length;d++)c[d].hasMember(a.user().id())&&b.push(c[d]);return b}},_.extend(Cow.user.prototype,Cow.record.prototype)}.call(this),function(){var a=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=Cow||{}),exports.Cow=Cow||{}):a.Cow=Cow||{},Cow.group=function(a){this._id=a._id||Cow.utils.idgen(),this._store=a.store,this._dirty="true",this._ttl=this._store.maxStaleness,this._deleted=!1,this._created=(new Date).getTime(),this._updated=(new Date).getTime(),this._data={},this._deltaq={},this._deltas=[],this._deltasforupload=[]},Cow.group.prototype={members:function(a){var b=this;switch(arguments.length){case 0:return this._getMembers();case 1:if(Array.isArray(a)){if(Array.isArray(a)){for(var c=0;c<a.length;c++){var d=a[c];b._addMember(d)}return this}throw"Wrong input: "+a}return this._addMember(a),this;default:throw"wrong argument number"}},_getMembers:function(){return this.data("members")||[]},_addMember:function(a){for(var b=!1,c=this.members(),d=0;d<c.length;d++)c[d]==a&&(b=!0);return b||(c.push(a),this.data("members",c)),a},removeMember:function(a){for(var b=(this._store._core,this.members()),c=0;c<b.length;c++)if(b[c]==a)return b.splice(c,1),this.data("members",b),this},removeAllMembers:function(){var a=[];return this.data("members",a),this},groups:function(a){var b=this;switch(arguments.length){case 0:return this._getGroups();case 1:return Array.isArray(a)?(a.forEach(function(c){var c=a[i];b._addGroup(c)}),this._getGroups()):this._addGroup(a);default:throw"wrong argument number"}},_getGroups:function(){return this.data("groups")||[]},_addGroup:function(a){for(var b=!1,c=this.groups(),d=0;d<this.groupList.length;d++)if(c[d]==a)return b=!0,a;return b||(c.push(a),this.data("groups",c)),a},removeGroup:function(a){for(var b=this.groups(),c=0;c<this.groupList.length;c++)if(b[c]==a)return b.splice(c,1),void self.data("groups",b)},removeAllGroups:function(){var a=[];this.data("groups",a)},hasMember:function(a){for(var b=!1,c=this.members(),d=0;d<c.length;d++)c[d]==a&&(b=!0);for(var e=[this._id],f=this.groups(),g=this._store._core,h=this._store._projectid,d=0;d<f.length;d++){var i=f[d].id;if(e.indexOf(i)<0){e.push(i);var j=g.projects(h).groups(i);b=j.hasMember(a)}}return b}},_.extend(Cow.group.prototype,Cow.record.prototype)}.call(this),function(){var a=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=Cow||{}),exports.Cow=Cow||{}):a.Cow=Cow||{},Cow.item=function(a){this._id=a._id||Cow.utils.idgen(),this._store=a.store,this._dirty="true",this._ttl=this._store.maxStaleness,this._deleted=!1,this._created=(new Date).getTime(),this._updated=(new Date).getTime(),this._data={},this._deltaq={},this._deltas=[],this._deltasforupload=[]},Cow.item.prototype={permissions:function(a,b){var c=this;switch(arguments.length){case 0:return c.data("permissions")||[];case 1:if("string"==typeof a)return c._permissionsByType(a);throw"type should be a string";case 2:if("string"==typeof a)return c._setPermission(a,b);throw"type should be a string";default:throw"wrong argument number"}},_permissionsByType:function(a){for(var b=this.permissions(),c=null,d=0;d<b.length;d++){var e=b[d];e.type==a&&(c=e)}return c},_setPermission:function(a,b){var c=this,d=this._permissionsByType(a),e=this.permissions();if(d)if(Array.isArray(b)||c.permissionHasGroup(a,b))for(var f=0;f<b.length;f++)c.permissionHasGroup(a,b[f])||d.groups.push(b[f]);else d.groups.push(b);else d=Array.isArray(b)?{type:a,groups:b}:{type:a,groups:[b]},e.push(d);return this.data("permissions",e),this},permissionHasGroup:function(a,b){var c=this.permissions(a),d=[];if(b&&Array.isArray(b)?d=b:b&&d.push(b),c){var e=c.groups;if(0===e.length)return!1;for(var f=!1,g=0;g<e.length;g++)for(var h=0;h<d.length;h++)e[g]==d[h]&&(f=!0);return f}return!1},hasPermission:function(a){var b=this._store._core,c=b.user().id(),d=b.projects(this._store._projectid),e=(d.groups(),!1),f=this.permissions(a);if(f)for(var g=0;g<f.groups.length;g++){var h=f.groups[g];void 0!==d.groups(h)&&d.groups(h).hasMember(c)&&(e=!0)}return e},removePermission:function(a,b){var c,d,e,f;switch(arguments.length){case 0:throw"this function doesn't take no arguments";case 1:if("string"==typeof a){for(c=null,e=this.permissions(),f=0;f<e.length;f++)d=e[f],d.type==a&&(c=f);return c>=0&&e.splice(c,1),this.data("permissions",e),this}throw"type should be a string";case 2:if("string"==typeof a){for(e=this.permissions(),f=0;f<e.length;f++)d=e[f],d.type==a&&(c=f);if(d=e[c]){var g=d.groups;if(g.length>=0)if(Array.isArray(b))for(f=0;f<b.length;f++){for(c=null,j=0;j<g.length;j++)g[j]==b[f]&&(c=j);c>=0&&g.splice(c,1)}else{for(c=null,f=0;f<g.length;f++)g[f]==b&&(c=f);c>=0&&g.splice(c,1)}d.groups=g,this.data("permissions",e)}return this}throw"type should be a string";default:throw"wrong argument number"}}},_.extend(Cow.item.prototype,Cow.record.prototype)}.call(this),function(){var a=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=Cow||{}),exports.Cow=Cow||{}):a.Cow=Cow||{},Cow.project=function(a){var b=this;this._id=a._id||Cow.utils.idgen(),this._store=a.store,this._core=this._store._core,this._maxAge=this._core._maxAge,this._dirty="true",this._ttl=this._store._maxAge,this._deleted=!1,this._created=(new Date).getTime(),this._updated=(new Date).getTime(),this._data={},this._deltaq={},this._deltas=[],this._deltasforupload=[];var c="groups";this._groupStore=_.extend(new Cow.syncstore({dbname:c,noIDB:!1,core:b._core,maxAge:this._maxAge}),{_records:[],_recordproto:function(a){return new Cow.group({_id:a,store:this})},_type:"groups",_dbname:c,_projectid:this._id,dbname:function(a){this._dbname=a}}),c="items",this._itemStore=_.extend(new Cow.syncstore({dbname:c,noIDB:!1,core:b._core,maxAge:this._maxAge}),{_recordproto:function(a){return new Cow.item({_id:a,store:this})},_projectid:this._id,_records:[],_type:"items",_dbname:c,dbname:function(a){this._dbname=a}})},Cow.project.prototype={closed:function(a){if(void 0!==a){this._closed=a;var b=this.deflate();return b.closed=this._closed,this._store._db_write({source:"UI",data:b}),this}return this._closed},groupStore:function(){return this._groupStore},groups:function(a){return this._groupStore.records(a)},itemStore:function(){return this._itemStore},items:function(a){return this._itemStore.records(a)},myGroups:function(){for(var a=this.groups(),b=this._core.user().id(),c=[],d=0;d<a.length;d++){var e=a[d];e.hasMember(b)&&c.push(e.id())}return c}},_.extend(Cow.project.prototype,Cow.record.prototype)}.call(this),function(){var a=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=Cow||{}),exports.Cow=Cow||{}):"undefined"==typeof Cow?a.Cow={}:a.Cow=Cow,Cow.websocket=function(a){this._core=a.core,this._url=a.url,this._connection=null,this._connected=!1},Cow.websocket.prototype.disconnect=function(){this._connection?(this._connection.close(),this._connection=null,this._connected=!1):console.log("No websocket active")},Cow.websocket.prototype.connect=function(){var a=this,b=this._core,c=new Promise(function(c,d){b.socketserver()?a._url=b.socketserver().url():(console.warn("No valid socketserver selected"),a._url=null),a._url||(console.warn("Nu URL given to connect to. Make sure you give a valid socketserver id as connect(id)"),d());if(a._connection&&1==a._connection.readyState&&"open"==a._connection.state)e=a._connection;else if(0===a._url.indexOf("ws")){var e=null;e=new WebSocket(a._url,"connect"),e.onopen=a._onOpen,e.onmessage=a._onMessage,e.onclose=a._onClose,e.onerror=a._onError,e._core=a._core,a._connection=e,a._connected=!0}else console.warn("Incorrect URL: "+a._url),d();c(e)});return c},Cow.websocket.prototype.connection=function(){return this._connection},Cow.websocket.prototype.send=function(a){!this._connection||1!=this._connection.readyState&&"open"!=this._connection.state||this._connection.send(a)},Cow.websocket.prototype._onOpen=function(){this._core.websocket().trigger("connected")},Cow.websocket.prototype._onMessage=function(a){this._core.websocket().trigger("message",a)},Cow.websocket.prototype._onError=function(a){this._core.peerStore().clear(),this._connected=!1,console.warn("error in websocket connection: "+a.type),this._core.websocket().trigger("error",a)},Cow.websocket.prototype._onClose=function(a){this._core.websocket().trigger("closed",a);var b=a.code,c=a.reason;a.wasClean;console.log("WS disconnected:",b,c),this._core.peerStore().clear(),this._connected=!1;var d=this,e=function(){try{console.log("Trying to reconnect"),d._core.websocket().disconnect()}catch(a){console.warn(a)}d._core.websocket().connect().then(function(a){d._connection=a},function(a){console.warn("connection failed",a)})};this._core._autoReconnect&&window.setTimeout(e,5e3)},_.extend(Cow.websocket.prototype,Events)}.call(this),function(){var a=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=Cow||{}),exports.Cow=Cow||{}):a.Cow=Cow||{},Cow.messenger=function(a){this._core=a.core,this._numreqs=0,this._amountreq=0,this._sendhistory=[],this._amountsendhistory=[],this._numsends=0,this._amountsend=0,this._reqhistory=[],this._amountreqhistory=[],this.ws=this._core.websocket(),this.ws.on("message",this._onMessage),this.ws.on("error",this._onError);var b=this,c=60;setInterval(function(){b._sendhistory.push(b._numsends),b._amountsendhistory.push(b._amountsend),b._sendhistory.length>c&&(b._sendhistory.shift(),b._amountsendhistory.shift()),b._reqhistory.push(b._numreqs),b._amountreqhistory.push(b._amountreq),b._reqhistory.length>c&&(b._reqhistory.shift(),b._amountreqhistory.shift()),b._numsends=0,b._amountsend=0,b._numreqs=0,b._amountreq=0},1e3)},Cow.messenger.prototype.activitylog=function(){return{reqhistory:this._reqhistory,sendhistory:this._sendhistory,amountreqhistory:this._amountreqhistory,amountsendhistory:this._amountsendhistory}},Cow.messenger.prototype.sendData=function(a,b,c){var d={};d.sender=this._core.peerid(),d.target=c,d.action=b,d.payload=lzw_encode(encode_utf8(JSON.stringify(a)));var e;try{e=JSON.stringify(d)}catch(f){console.error(f,d)}this.ws.send(e),this._numsends++,this._amountsend=+e.length},Cow.messenger.prototype._onMessage=function(a){var b=this._core,c=JSON.parse(a.data),d=c.sender,e=b.peerid(),f=c.action;"object"==typeof c.payload?c.payload=c.payload:c.payload=JSON.parse(decode_utf8(lzw_decode(c.payload)));var g=c.payload,h=c.target;switch(d!=e&&(this._core.messenger()._numreqs++,this._core.messenger()._amountreq=+a.data.length),f){case"command":d!=e&&this._core.messenger()._onCommand(c);break;case"connected":this._core.messenger()._onConnect(g);break;case"peerGone":this._core.messenger()._onPeerGone(g);break;case"newList":d!=e&&this._core.messenger()._onNewList(g,d);break;case"syncinfo":d!=e&&this._core.messenger()._onSyncinfo(g,d);break;case"wantedList":h==e&&this._core.messenger()._onWantedList(g);break;case"missingRecord":h==e&&this._core.messenger()._onMissingRecord(g);break;case"requestedRecord":d!=e&&this._core.messenger()._onMissingRecord(g);break;case"updatedRecord":d!=e&&this._core.messenger()._onUpdatedRecord(g)}},Cow.messenger.prototype._onConnect=function(a){function b(){console.log("Starting sync"),c._core.projectStore().sync(),c._core.socketserverStore().sync(),c._core.peerStore().sync(),c._core.userStore().sync(),c._core.projectStore().synced.then(function(){for(var a=c._core.projects(),b=0;b<a.length;b++){var d=a[b];d.deleted()||(syncarray.push([d.itemStore().synced,d.groupStore().synced]),d.itemStore().sync(),d.groupStore().sync())}Promise.all(syncarray).then(function(a){console.log("all synced")})})}console.log("connected!"),this._connected=!0;var c=this;this._core.peerid(a.peerID);var d=this._core.peers({_id:a.peerID}),e=(a.server_version,a.server_key),f=a.server_time,g=(new Date).getTime(),h=3e5;if(Math.abs(f-g)>h)return console.warn("Time difference between server and client larger ("+Math.abs(f-g)+"ms) than allowed ("+h+" ms)."),void c.ws.disconnect();if(void 0!==e&&e!=this._core._herdname)return console.warn("Key on server ("+e+") not the same as client key ("+this._core._herdname+")."),void c.ws.disconnect();this._core.user()&&d.data("userid",this._core.user().id()),d.data("version",this._core.version()),d.deleted(!1).sync(),this.trigger("connected",a);var i=[this._core.socketserverStore().loaded,this._core.peerStore().loaded,this._core.userStore().loaded,this._core.projectStore().loaded];Promise.all(i).then(function(){for(var a=c._core.projects(),d=[],e=0;e<a.length;e++){var f=a[e];f.deleted()||d.push([f.itemStore().loaded,f.groupStore().loaded]);
}Promise.all(d).then(b)}),syncarray=[this._core.socketserverStore().synced,this._core.peerStore().synced,this._core.userStore().synced,this._core.projectStore().synced]},Cow.messenger.prototype._onPeerGone=function(a){var b=a.gonePeerID.toString();this._core.peers(b)&&this._core.peers(b).deleted(!0).sync(),this._core.peerStore().pruneDeleted()},Cow.messenger.prototype._getStore=function(a){var b,c=a.syncType,d=a.project?a.project.toString():null;switch(c){case"peers":return this._core.peerStore();case"socketservers":return this._core.socketserverStore();case"projects":return this._core.projectStore();case"users":return this._core.userStore();case"items":if(!d)throw"No project id given";if(!this._core.projects(d))throw"No project with id "+d+" Indexeddb too slow with loading?";return b=this._core.projects(d),b.itemStore();case"groups":if(!d)throw"No project id given";if(!this._core.projects(d))throw"No project with id "+d+" Indexeddb too slow with loading?";return b=this._core.projects(d),b.groupStore()}},Cow.messenger.prototype._onNewList=function(a,b){var c=this;if(this._amIAlpha()){var d,e=this._getStore(a),f=e._projectid,g=e.compareRecords({uid:b,list:a.list}),h={IWillSent:_.pluck(g.pushlist,"_id"),IShallReceive:g.requestlist};d={syncType:a.syncType,project:f,syncinfo:h},this.sendData(d,"syncinfo",b),d={syncType:a.syncType,project:f,list:g.requestlist},g.requestlist.length>0&&this.sendData(d,"wantedList",b),g.pushlist.forEach(function(d){msg={syncType:a.syncType,project:f,record:d},c.sendData(msg,"missingRecord",b)})}},Cow.messenger.prototype._amIAlpha=function(){var a=null,b=this._core.alphaPeer(),c=this._core.peer();return a=c.id()==b.id()},Cow.messenger.prototype._onSyncinfo=function(a){var b=this._getStore(a);b.syncinfo.toReceive=a.syncinfo.IWillSent,b.syncinfo.toSent=a.syncinfo.IShallReceive,b.syncinfo.toReceive.length<1&&b.trigger("synced")},Cow.messenger.prototype._onWantedList=function(a){var b=this,c=this._getStore(a),d=c.requestRecords(a.list);d.forEach(function(d){msg={syncType:a.syncType,project:c._projectid,record:d},b.sendData(msg,"requestedRecord")})},Cow.messenger.prototype._onMissingRecord=function(a){var b=this._getStore(a),c=a.record,d=b._addRecord({source:"WS",data:c});if(b._commit(),b.trigger("datachange"),b.syncinfo.toReceive=_.without(b.syncinfo.toReceive,c._id),b.syncinfo.toReceive.length<1&&b.trigger("synced"),c.deltas&&d.deltas()){var e=_.pluck(d.deltas(),"timestamp"),f=_.pluck(c.deltas,"timestamp"),g=_.difference(e,f);g.length>0&&b.syncRecord(d)}},Cow.messenger.prototype._onUpdatedRecord=function(a){var b=this._getStore(a),c=a.record;b._addRecord({source:"WS",data:c}),b._commit(),b.trigger("datachange")},Cow.messenger.prototype._onCommand=function(a){var b=this._core,c=a.payload,d=c.command,e=c.target;c.params;if(this.trigger("command",a),"kickPeer"==d&&a.target==b.peerid()&&(b.socketserver("invalid"),b.disconnect()),"purgePeer"==d&&e&&e==this._core.peerid()&&(b.projects().forEach(function(a){a.itemStore().clear(),a.groupStore().clear()}),b.projectStore().clear(),b.userStore().clear()),"flushProject"==d){var f,g=c.projectid;b.projects(g)&&(f=b.projects(g),f.itemStore().clear())}"ping"==d&&this.sendData({command:"pong"},"command",a.sender)},_.extend(Cow.messenger.prototype,Events)}.call(this),function(){var a=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=Cow||{}),exports.Cow=Cow||{}):a.Cow=Cow||{},Cow.core=function(a){var b=this;"undefined"==typeof a&&(a={}),this._version="2.2.5",this._herdname=a.herdname||"cow",this._userid=null,this._socketserverid=null,this._projectid=null,this._wsUrl=null,this._peerid=null,this._maxAge=a.maxAge||10368e6,this._autoReconnect=a.autoReconnect||!0,this._localdb=new Cow.localdb({dbname:this._herdname,core:this}),this._projectStore=_.extend(new Cow.syncstore({dbname:"projects",noIDB:!1,noDeltas:!1,core:b,maxAge:this._maxAge}),{_records:[],_recordproto:function(a){return new Cow.project({_id:a,store:this})},_dbname:"projects",_type:"projects"}),this._peerStore=_.extend(new Cow.syncstore({dbname:"peers",noIDB:!0,noDeltas:!0,core:this}),{_records:[],_recordproto:function(a){return new Cow.peer({_id:a,store:this})},_dbname:"peers",_type:"peers",removePeer:function(a){return this._removeRecord(a)}}),this._userStore=_.extend(new Cow.syncstore({dbname:"users",noIDB:!1,noDeltas:!0,core:this}),{_records:[],_recordproto:function(a){return new Cow.user({_id:a,store:this})},_dbname:"users",_type:"users"}),this._socketserverStore=_.extend(new Cow.syncstore({dbname:"socketservers",noIDB:!1,noDeltas:!0,core:this}),{_records:[],_recordproto:function(a){return new Cow.socketserver({_id:a,store:this})},_dbname:"socketservers",_type:"socketservers"}),this._websocket=new Cow.websocket({core:this,url:this._wsUrl}),this._messenger=new Cow.messenger({core:this})},Cow.core.prototype={peerid:function(a){return a?(this._peerid=a.toString(),this._peerid):this._peerid?this._peerid.toString():null},project:function(a){if(a){a=a.toString();var b=this.projects(a);return b?(this._projectid=a,this.peer()&&this.peer().data("activeproject",a).sync(),this.trigger("projectChanged"),!0):(console.warn("Trying to select a non existing project"),!1)}return this._projectid?this.projects(this._projectid):!1},user:function(a){return a?(a=a.toString(),this._userid=a,this.peer()&&this.peers(this.peerid())&&this.peer().data("userid",a).sync(),this.users(a)):this._userid?this.users(this._userid):!1},version:function(){return this._version},socketserver:function(a){return a?(a=a.toString(),this._socketserverid=a,this.socketservers(a)):this._socketserverid?this.socketservers(this._socketserverid):!1},peer:function(){return this.peerid()?this.peers(this.peerid()):!1},location:function(a){return a?(this._location=a,this.peerid()&&this.peers(this.peerid()).data("location",a).sync(),this._location):this._location},projectStore:function(){return this._projectStore},projects:function(a){return this._projectStore.records(a)},peerStore:function(){return this._peerStore},peers:function(a){return this._peerStore.records(a)},socketserverStore:function(){return this._socketserverStore},socketservers:function(a){return this._socketserverStore.records(a)},userStore:function(){return this._userStore},users:function(a){return this._userStore.records(a)},activeUsers:function(){for(var a=[],b=this.peers().filter(function(a){return!a.deleted()}),c=0;c<b.length;c++)b[c].user()&&a.push(b[c].user());return _.uniq(a)},alphaPeer:function(){var a=_.sortBy(this.peers().filter(function(a){return"alpha"==a.data("family")&&!a.deleted()}),function(a){return a.created()});return a[0]},dbopen:function(){return this._localdb._openpromise},websocket:function(){return this._websocket},messenger:function(){return this._messenger},localdb:function(){return this._localdb},connect:function(){return this._websocket.connect()},disconnect:function(){return this._websocket.disconnect()}},_.extend(Cow.core.prototype,Events)}.call(this);