/*! cow VERSION: 0.1.0 04-09-2014 */
(function(){var a=[],b=(a.push,a.slice),c=(a.splice,{on:function(a,b,c){if(!e(this,"on",a,[b,c])||!b)return this;this._events||(this._events={});var d=this._events[a]||(this._events[a]=[]);return d.push({callback:b,context:c,ctx:c||this}),this},once:function(a,b,c){if(!e(this,"once",a,[b,c])||!b)return this;var d=this,f=_.once(function(){d.off(a,f),b.apply(this,arguments)});return f._callback=b,this.on(a,f,c)},off:function(a,b,c){var d,f,g,h,i,j,k,l;if(!this._events||!e(this,"off",a,[b,c]))return this;if(!a&&!b&&!c)return this._events=void 0,this;for(h=a?[a]:_.keys(this._events),i=0,j=h.length;j>i;i++)if(a=h[i],g=this._events[a]){if(this._events[a]=d=[],b||c)for(k=0,l=g.length;l>k;k++)f=g[k],(b&&b!==f.callback&&b!==f.callback._callback||c&&c!==f.context)&&d.push(f);d.length||delete this._events[a]}return this},trigger:function(a){if(!this._events)return this;var c=b.call(arguments,1);if(!e(this,"trigger",a,c))return this;var d=this._events[a],g=this._events.all;return d&&f(d,c),g&&f(g,arguments),this},stopListening:function(a,b,c){var d=this._listeningTo;if(!d)return this;var e=!b&&!c;c||"object"!=typeof b||(c=this),a&&((d={})[a._listenId]=a);for(var f in d)a=d[f],a.off(b,c,this),(e||_.isEmpty(a._events))&&delete this._listeningTo[f];return this}}),d=/\s+/,e=function(a,b,c,e){if(!c)return!0;if("object"==typeof c){for(var f in c)a[b].apply(a,[f,c[f]].concat(e));return!1}if(d.test(c)){for(var g=c.split(d),h=0,i=g.length;i>h;h++)a[b].apply(a,[g[h]].concat(e));return!1}return!0},f=function(a,b){var c,d=-1,e=a.length,f=b[0],g=b[1],h=b[2];switch(b.length){case 0:for(;++d<e;)(c=a[d]).callback.call(c.ctx);return;case 1:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f);return;case 2:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g);return;case 3:for(;++d<e;)(c=a[d]).callback.call(c.ctx,f,g,h);return;default:for(;++d<e;)(c=a[d]).callback.apply(c.ctx,b)}},g={listenTo:"on",listenToOnce:"once"};_.each(g,function(a,b){c[b]=function(b,c,d){var e=this._listeningTo||(this._listeningTo={}),f=b._listenId||(b._listenId=_.uniqueId("l"));return e[f]=b,d||"object"!=typeof c||(d=this),b[a](c,d,this),this}}),c.bind=c.on,c.unbind=c.off;var h=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=c),exports.Events=c):h.Events=c}).call(this);var Cow={};(function(){var a=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=Cow||{}),exports.Cow=Cow||{}):(a.Cow=Cow||{},a._=_),Cow.utils={idgen:function(){return(new Date).getTime().toString()}}}).call(this),function(){var a=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=Cow||{}),exports.Cow=Cow||{}):a.Cow=Cow||{},Cow.record=function(){this._id=null,this._status="dirty",this._dirty=!1,this._deleted=!1,this._created=(new Date).getTime(),this._updated=(new Date).getTime(),this._data={},this._deltaq={},this._deltas=[],this._deltasforupload=[]},Cow.record.prototype={sync:function(){var a=(new Date).getTime();return _(this._deltaq).size()>0&&!this._store.noDeltas&&this.deltas(a,this._deltaq),this._deltaq={},this._store.syncRecord(this)},id:function(){return this._id.toString()},created:function(){return this._created},timestamp:function(a){return console.warn("timestamp() has been deprecated. Use updated() instead"),a?(this._updated=a,this):this._updated},updated:function(a){return a?(this._updated=a,this):this._updated},touch:function(){return this.updated((new Date).getTime()),this},deleted:function(a){return void 0!==a?(this._deleted=a,this.updated((new Date).getTime()),this._dirty=!0,this):this._deleted},dirty:function(a){return void 0!==a?(this._dirty=a,this._status=this._dirty?"dirty":"clean",this.updated((new Date).getTime()),this):this._dirty},status:function(a){return a?(this._status=a,this._dirty="dirty"==this._status?!0:!1,this.updated((new Date).getTime()),this):this._status},data:function(a,b){return a?a&&"object"==typeof a&&!b?(this._data=a,this.dirty(!0),this):a&&"string"==typeof a&&!b?this._data[a]:a&&"number"==typeof a&&!b?this.data_on(a):a&&b?("object"==typeof b&&(b=JSON.parse(JSON.stringify(b))),this._data[a]=b,this._deltaq[a]=b,this.dirty(!0),this):void 0:"object"==typeof this._data?JSON.parse(JSON.stringify(this._data)):this._data},data_on:function(a){if(a<this._created)return null;if(a>this._updated)return this.data();var b={},c=_.sortBy(this.deltas(),function(a){return a.timestamp});return _.each(c,function(c){c.timestamp<=a&&_.extend(b,c.data)}),b},deltas:function(a,b){if(!a)return this._deltas;if(a&&!b){for(var c=0;c<this._deltas.length;c++)if(this._deltas[c].timestamp==a)return this._deltas[c];return null}if(a&&b){for(var d=!1,e=0;e<this._deltas.length;e++)this._deltas[e].timestamp==a&&(d=!0);return d||this._deltas.push({timestamp:a,data:b}),this}},deflate:function(){return{_id:this._id,status:this._status,dirty:this._dirty,created:this._created,deleted:this._deleted,updated:this._updated,data:this._data,deltas:this._deltas}},inflate:function(a){if(this._id=a._id||this._id||(new Date).getTime().toString(),this._status=a.status||this._status,this._dirty=void 0!==a.dirty?a.dirty:"clean"==this._status?!1:!0,this._created=a.created||this._created,void 0!==a.deleted&&(this._deleted=a.deleted),this._updated=a.updated||this._updated,this._data=a.data||this._data||{},!this._store.noDeltas&&(this._deltaq=this._deltaq||{},this._deltasforupload=this._deltasforupload||{},this._deltas=this._deltas||[],a.deltas))for(var b=0;b<a.deltas.length;b++){var c=a.deltas[b].timestamp,d=a.deltas[b].data;this.deltas(c,d)}return this}}}.call(this),function(){var a=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=Cow||{}),exports.Cow=Cow||{}):a.Cow="undefined"==typeof Cow?{}:Cow,Cow.localdb=function(a){var b=this;this._dbname=a.dbname,this._core=a.core,this._db=null;var c="tcp://geodan:Gehijm@192.168.24.15/cow";this._schema=b._dbname,this._openpromise=new Promise(function(a,d){pg.connect(c,function(c,e){c&&(console.log(c),d(c)),b._db=e;var f="CREATE SCHEMA IF NOT EXISTS "+b._schema;e.query(f,function(a){return a?(console.log(a),void d(a)):void 0});for(var g=["users","projects","socketservers","items","groups"],h=0;h<g.length;h++){var i="CREATE TABLE IF NOT EXISTS "+b._schema+"."+g[h]+' (_id text NOT NULL, "dirty" boolean,"deleted" boolean,"created" bigint,"updated" bigint,"data" json,"deltas" json,"projectid" text);';e.query(i,function(a){return a?(console.log(a),void d(a)):void 0})}e.on("notification",function(a){var c=a.payload;switch(console.log(c," has been changed in the database"),c){case"users":b._core.userStore()._loadFromDb().then(function(){b._core.userStore().sync(),console.log("loaded")},function(a){console.log("Error: ",a)});break;default:console.warn("Update from unknown table: ",c)}}),e.query("LISTEN watchers"),a()})})},Cow.localdb.prototype.write=function(a){var b=this,c=a.storename,d=a.data,e=a.projectid;d._id=d._id.toString(),d.projectid=e;var f=new Promise(function(a,e){var f="DELETE FROM "+b._schema+"."+c+" WHERE _id = '"+d._id+"';";b._db.query(f,function(g){g&&(console.log(g,f),e(g)),f="INSERT INTO "+b._schema+"."+c+" VALUES($1, $2, $3, $4, $5, $6, $7, $8)";var h=[d._id,d.dirty,d.deleted,d.created,d.updated,JSON.stringify(d.data),JSON.stringify(d.deltas),d.projectid];b._db.query(f,h,function(b){b&&(console.log(b,f),e(b)),a()})})});return f},Cow.localdb.prototype.getRecord=function(a){var b=this,c=a.storename,d=a.id,e=new Promise(function(a,e){var f="SELECT * FROM "+b._schema+"."+c+" WHERE _id = '"+d+"';";b._db.query(f,function(b,c){if(b)return void e(b);var d=c.rows[0];a(d)})});return e},Cow.localdb.prototype.getRecords=function(a){var b,c=this,d=a.storename,e=a.projectid;b=e?"SELECT * FROM "+this._schema+"."+d+" WHERE projectid = '"+e+"';":"SELECT * FROM "+this._schema+"."+d+";";var f=new Promise(function(a,d){c._db.query(b,function(b,c){b?d(b):a(c.rows)})});return f},Cow.localdb.prototype.delRecord=function(){var a=new Promise(function(a,b){console.warn("delRecord not used with postgres"),b()});return a}}.call(this),function(){var a=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=Cow||{}),exports.Cow=Cow||{}):a.Cow=Cow||{},Cow.syncstore=function(a){var b=this;this._storename=a.dbname,this._core=a.core,this.noDeltas=a.noDeltas||!1,this.noIDB=a.noIDB||!1,this.maxStaleness=a.maxAge||null,this.syncinfo={toReceive:[],toSent:[],received:0,send:0},this.noIDB||(this.localdb=this._core.localdb()),this.loaded=new Promise(function(a,c){b.localdb?b._core.dbopen().then(function(){b.localdb.getRecords({storename:b._storename,projectid:b._projectid}).then(function(c){c.forEach(function(a){var c=b._recordproto(a._id);c.inflate(a);for(var d=c.updated(),e=(new Date).getTime(),f=e-d,g=!1,h=0;h<b._records.length;h++)b._records[h]._id==c._id&&(g=!0);!g&&(f<=b.maxStaleness||null===b.maxStaleness)&&b._records.push(c),b.maxStaleness&&f>b.maxStaleness&&b.localdb.delRecord({storename:b._storename,projectid:b._projectid,id:c._id})}),b.trigger("datachange"),a()},function(a){console.warn("DB Fail"),c(a)})},function(a){console.warn("DB Fail"),c(a)}):a()})},Cow.syncstore.prototype={_loadFromDb:function(){var a=this;return new Promise(function(b,c){a.localdb.getRecords({storename:a._storename,projectid:a._projectid}).then(function(c){c.forEach(function(b){var c=a._recordproto(b._id);c.inflate(b);for(var d=c.updated(),e=(new Date).getTime(),f=e-d,g=!1,h=0;h<a._records.length;h++)a._records[h]._id==c._id&&a._records[h]._updated<c._updated?(a._records.splice(h,1,c),g=!0):a._records[h]._id==c._id&&a._records[h]._updated>=c._updated&&(g=!0);!g&&(f<=a.maxStaleness||null===a.maxStaleness)?a._records.push(c):a.maxStaleness&&f>a.maxStaleness&&a.localdb.delRecord({storename:a._storename,projectid:a._projectid,id:c._id})}),a.trigger("datachange"),b()},function(a){console.warn("DB Fail"),c(a)})})},_getRecords:function(a){for(var b=[],c=0;c<this._records.length;c++){var d=this._records[c];a.indexOf(d._id)>-1&&b.push(d)}return b},_getRecord:function(a){for(var b=0;b<this._records.length;b++){var c=this._records[b];if(c._id==a)return c}return null},_addRecord:function(a){if(!a.source||!a.data)return console.warn("Wrong input: ",a),!1;for(var b,c=null,d=a.source,e=a.data,f=!1,g=0;g<this._records.length;g++)this._records[g]._id==e._id&&(f=!0,b=this._records[g],b.inflate(e),this.localdb&&"WS"==d&&this.localdb.write({storename:this._storename,projectid:this._projectid,data:b.deflate()}));return f||(b=this._recordproto(e._id),b.inflate(e),this.localdb&&"WS"==d&&(c=this.localdb.write({storename:this._storename,projectid:this._projectid,data:b.deflate()})),this._records.push(b)),b},_getRecordsOn:function(a){var b=[];return _.each(this._records,function(c){a<c._created||(a>c._updated?b.push(c):c.data(a)&&b.push(c))}),b},records:function(a){return a&&Array.isArray(a)?this._getRecords(a):a&&"object"==typeof a?this._addRecord({source:"UI",data:a}).dirty(!0):a&&"string"==typeof a?this._getRecord(a):a&&"number"==typeof a?void 0:this._records},_removeRecord:function(a){for(var b=0;b<this._records.length;b++)if(this._records[b]._id==a)return this._records.splice(b,1),!0;return!1},clear:function(){var a=this;return new Promise(function(b){a._records=[],a.trigger("datachange"),a.localdb?a.localdb.clear().then(function(){b()}):b()})},deleteAll:function(){for(var a=0;a<this._records.length;a++)this._records[a].deleted(!0);return this.syncRecords(),this.trigger("datachange"),this},syncRecord:function(a){var b,c=this,d={};return d.syncType=this._type,a.dirty(!1),this._projectid&&(d.project=this._projectid),b=this.localdb?this.localdb.write({storename:this._storename,projectid:this._projectid,data:a.deflate()}):new Promise(function(a){a()}),b.then(function(){d.record=a.deflate(),c.trigger("datachange"),c._core.messenger().sendData(d,"updatedRecord")},function(a){console.warn(a)}),a},syncRecords:function(){for(var a=[],b=0;b<this._records.length;b++){var c=this._records[b];c.dirty()&&(c.dirty(!1),a.push(c.deflate()))}var d={syncType:this._type,project:this._projectid,list:a};this._core.messenger().sendData(d,"requestedRecords")},deltaList:function(){},compareDeltas:function(){},sync:function(){var a=this;this.loaded.then(function(){var b={};b.syncType=a._type,b.project=a._projectid,b.list=a.idList(),a._core.messenger().sendData(b,"newList")}),this.loaded.catch(function(a){console.error(a.message)})},idList:function(){for(var a=[],b=0;b<this._records.length;b++){var c=this._records[b],d={};d._id=c._id,d.timestamp=c.updated(),d.deleted=c.deleted(),a.push(d)}return a},requestRecords:function(a){for(var b=[],c=0;c<this._records.length;c++){var d=this._records[c];for(j=0;j<a.length;j++){var e=a[j];e==d._id&&b.push(d.deflate())}}return b},compareRecords:function(a){var b=(a.uid,a.list),c={},d=[];c.requestlist=[],c.pushlist=[];var e;if(b){for(e=0;e<b.length;e++)d.push(b[e]._id);for(e=0;e<this._records.length;e++){for(var f=this._records[e],g=-1,h=0;h<b.length;h++){var i=b[h];if(i._id==f._id){g=1,i.timestamp<f._updated?c.pushlist.push(f.deflate()):i.timestamp>f._updated&&c.requestlist.push(i._id);var j=d.indexOf(f._id);j>=0&&d.splice(j,1)}}-1==g&&"true"!=f.deleted()&&c.pushlist.push(f.deflate())}}for(e=0;e<d.length;e++){var k=d[e];c.requestlist.push(k)}return c}},_.extend(Cow.syncstore.prototype,Events)}.call(this),function(){var a=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=Cow||{}),exports.Cow=Cow||{}):a.Cow=Cow||{},Cow.peer=function(a){this._id=a._id,this._store=a.store,this._core=this._store._core,this._data={userid:null,family:"alpha"},this._dirty="true",this._deleted=!1,this._created=(new Date).getTime(),this._updated=(new Date).getTime(),this._deltaq={},this._deltas=[],this._deltasforupload=[]},Cow.peer.prototype={user:function(a){if(a)return this.data("userid",a).sync();if(this.data("userid")){var b=this.data("userid");return this._core.users(b)}return null},username:function(){return this.user()?this.user().data("name"):null}},_.extend(Cow.peer.prototype,Cow.record.prototype)}.call(this),function(){var a=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=Cow||{}),exports.Cow=Cow||{}):a.Cow=Cow||{},Cow.socketserver=function(a){this._id=a._id,this._store=a.store,this._core=this._store._core,this._data={protocol:null,ip:null,port:null,dir:null},this._dirty=!0,this._deleted=!1,this._created=(new Date).getTime(),this._updated=(new Date).getTime(),this._deltaq={},this._deltas=[],this._deltasforupload=[]},Cow.socketserver.prototype={url:function(){var a=this.data("protocol"),b=this.data("ip"),c=this.data("port"),d=this.data("dir")||"";return a+"://"+b+":"+c+"/"+d}},_.extend(Cow.socketserver.prototype,Cow.record.prototype)}.call(this),function(){var a=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=Cow||{}),exports.Cow=Cow||{}):a.Cow=Cow||{},Cow.user=function(a){this._id=a._id,this._store=a.store,this._dirty=!0,this._deleted=!1,this._created=(new Date).getTime(),this._updated=(new Date).getTime(),this._data={},this._deltaq={},this._deltas=[],this._deltasforupload=[]},Cow.user.prototype={name:function(a){return a?this.data("name",a):this.data("name")},mail:function(a){return a?this.data("mail",a):this.data("mail")},isActive:function(){for(var a=!1,b=this._store._core.peers(),c=0;c<b.length;c++)b[c].user()!=this._id||b[c].deleted()||(a=!0);return a},groups:function(){var a=this._store._core,b=[];if(!a.project())return console.warn("No active project"),null;for(var c=a.project().groups(),d=0;c.length;d++)c[d].hasMember(a.user().id())&&b.push(c[d]);return b},activeprojects:function(a,b){var c=this.data("activeprojects")||[];if(a&&b){var d=c.indexOf(a);return c.splice(d,1),this.data("activeprojects",c)}return a?(c.push(a),this.data("activeprojects",c)):this.data("activeprojects")||[]},mutedprojects:function(a,b){var c=this.data("mutedprojects")||[];if(a&&b){var d=c.indexOf(a);return c.splice(d,1),this.data("mutedprojects",c)}return a?(c.push(a),this.data("mutedprojects",c)):this.data("mutedprojects")||[]}},_.extend(Cow.user.prototype,Cow.record.prototype)}.call(this),function(){var a=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=Cow||{}),exports.Cow=Cow||{}):a.Cow=Cow||{},Cow.group=function(a){this._id=a._id,this._store=a.store,this._dirty="true",this._deleted=!1,this._created=(new Date).getTime(),this._updated=(new Date).getTime(),this._data={},this._deltaq={},this._deltas=[],this._deltasforupload=[]},Cow.group.prototype={members:function(a){var b=this;switch(arguments.length){case 0:return this._getMembers();case 1:if(Array.isArray(a)){if(Array.isArray(a)){for(var c=0;c<a.length;c++){var d=a[c];b._addMember(d)}return this}throw"Wrong input: "+a}return this._addMember(a),this;default:throw"wrong argument number"}},_getMembers:function(){return this.data("members")||[]},_addMember:function(a){for(var b=!1,c=this.members(),d=0;d<c.length;d++)c[d]==a&&(b=!0);return b||(c.push(a),this.data("members",c)),a},removeMember:function(a){for(var b=(this._store._core,this.members()),c=0;c<b.length;c++)if(b[c]==a)return b.splice(c,1),this.data("members",b),this},removeAllMembers:function(){var a=[];return this.data("members",a),this},groups:function(a){var b=this;switch(arguments.length){case 0:return this._getGroups();case 1:if(Array.isArray(a)){for(var c=0;c<a.length;c++){var d=a[c];b._addGroup(d)}return this._getGroups()}return this._addGroup(a);default:throw"wrong argument number"}},_getGroups:function(){return this.data("groups")||[]},_addGroup:function(a){for(var b=!1,c=this.groups(),d=0;d<this.groupList.length;d++)if(c[d]==a)return b=!0,a;return b||(c.push(a),this.data("groups",c)),a},removeGroup:function(a){for(var b=this.groups(),c=0;c<this.groupList.length;c++)if(b[c]==a)return b.splice(c,1),void self.data("groups",b)},removeAllGroups:function(){var a=[];this.data("groups",a)},hasMember:function(a){for(var b=!1,c=this.members(),d=0;d<c.length;d++)c[d]==a&&(b=!0);for(var e=[this._id],f=this.groups(),g=this._store._core,h=this._store._projectid,d=0;d<f.length;d++){var i=f[d].id;if(e.indexOf(i)<0){e.push(i);var j=g.projects(h).groups(i);b=j.hasMember(a)}}return b}},_.extend(Cow.group.prototype,Cow.record.prototype)}.call(this),function(){var a=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=Cow||{}),exports.Cow=Cow||{}):a.Cow=Cow||{},Cow.item=function(a){this._id=a._id,this._store=a.store,this._dirty="true",this._deleted=!1,this._created=(new Date).getTime(),this._updated=(new Date).getTime(),this._data={},this._deltaq={},this._deltas=[],this._deltasforupload=[]},Cow.item.prototype={permissions:function(a,b){var c=this;switch(arguments.length){case 0:return c.data("permissions")||[];case 1:if("string"==typeof a)return c._permissionsByType(a);throw"type should be a string";case 2:if("string"==typeof a)return c._setPermission(a,b);throw"type should be a string";default:throw"wrong argument number"}},_permissionsByType:function(a){for(var b=this.permissions(),c=null,d=0;d<b.length;d++){var e=b[d];e.type==a&&(c=e)}return c},_setPermission:function(a,b){var c=this,d=this._permissionsByType(a),e=this.permissions();if(d)if(Array.isArray(b)||c.permissionHasGroup(a,b))for(var f=0;f<b.length;f++)c.permissionHasGroup(a,b[f])||d.groups.push(b[f]);else d.groups.push(b);else d=Array.isArray(b)?{type:a,groups:b}:{type:a,groups:[b]},e.push(d);return this.data("permissions",e),this},permissionHasGroup:function(a,b){var c=this.permissions(a),d=[];if(b&&Array.isArray(b)?d=b:b&&d.push(b),c){var e=c.groups;if(0===e.length)return!1;for(var f=!1,g=0;g<e.length;g++)for(var h=0;h<d.length;h++)e[g]==d[h]&&(f=!0);return f}return!1},hasPermission:function(a){var b=this._store._core,c=b.user().id(),d=b.projects(this._store._projectid),e=(d.groups(),!1),f=this.permissions(a);if(f)for(var g=0;g<f.groups.length;g++){var h=f.groups[g];void 0!==d.groups(h)&&d.groups(h).hasMember(c)&&(e=!0)}return e},removePermission:function(a,b){var c,d,e,f;switch(arguments.length){case 0:throw"this function doesn't take no arguments";case 1:if("string"==typeof a){for(c=null,e=this.permissions(),f=0;f<e.length;f++)d=e[f],d.type==a&&(c=f);return c>=0&&e.splice(c,1),this.data("permissions",e),this}throw"type should be a string";case 2:if("string"==typeof a){for(e=this.permissions(),f=0;f<e.length;f++)d=e[f],d.type==a&&(c=f);if(d=e[c]){var g=d.groups;if(g.length>=0)if(Array.isArray(b))for(f=0;f<b.length;f++){for(c=null,j=0;j<g.length;j++)g[j]==b[f]&&(c=j);c>=0&&g.splice(c,1)}else{for(c=null,f=0;f<g.length;f++)g[f]==b&&(c=f);c>=0&&g.splice(c,1)}d.groups=g,this.data("permissions",e)}return this}throw"type should be a string";default:throw"wrong argument number"}}},_.extend(Cow.item.prototype,Cow.record.prototype)}.call(this),function(){var a=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=Cow||{}),exports.Cow=Cow||{}):a.Cow=Cow||{},Cow.project=function(a){var b=this;if(!a._id)throw"No _id given for project";this._id=a._id,this._store=a.store,this._core=this._store._core,this._maxAge=this._core._maxAge,this._dirty="true",this._deleted=!1,this._created=(new Date).getTime(),this._updated=(new Date).getTime(),this._data={},this._deltaq={},this._deltas=[],this._deltasforupload=[];var c="groups";this._groupStore=_.extend(new Cow.syncstore({dbname:c,core:b._core,maxAge:this._maxAge}),{_records:[],_recordproto:function(a){return new Cow.group({_id:a,store:this})},_type:"groups",_dbname:c,_projectid:this._id,dbname:function(a){this._dbname=a}}),c="items",this._itemStore=_.extend(new Cow.syncstore({dbname:c,core:b._core,maxAge:this._maxAge}),{_recordproto:function(a){return new Cow.item({_id:a,store:this})},_projectid:this._id,_records:[],_type:"items",_dbname:c,dbname:function(a){this._dbname=a}})},Cow.project.prototype={closed:function(a){if(void 0!==a){this._closed=a;var b=this.deflate();return b.closed=this._closed,this._store._db_write({source:"UI",data:b}),this}return this._closed},groupStore:function(){return this._groupStore},groups:function(a){return this._groupStore.records(a)},itemStore:function(){return this._itemStore},items:function(a){return this._itemStore.records(a)},myGroups:function(){for(var a=this.groups(),b=this._core.user().id(),c=[],d=0;d<a.length;d++){var e=a[d];e.hasMember(b)&&c.push(e.id())}return c}},_.extend(Cow.project.prototype,Cow.record.prototype)}.call(this),function(){var a=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=Cow||{}),exports.Cow=Cow||{}):a.Cow="undefined"==typeof Cow?{}:Cow,Cow.websocket=function(a){this._core=a.core,this._url=a.url,this._connection=null,this._connected=!1},Cow.websocket.prototype.disconnect=function(){this._connection?(this._connection.close(),this._connection=null):console.log("No websocket active")},Cow.websocket.prototype.connect=function(){var a=this,b=this._core,c=new Promise(function(c,d){if(b.socketserver()&&(a._url=b.socketserver().url()),!a._url)return console.warn("Nu URL given to connect to. Make sure you give a valid socketserver id as connect(id)"),d(),!1;if(a._connection&&1==a._connection.readyState&&"open"==a._connection.state)e=a._connection;else if(0===a._url.indexOf("ws")){var e=null;e=new WebSocket,e.on("connectFailed",function(a){console.log("Connect Error: "+a.toString())}),e.on("connect",function(b){console.log("WebSocket client connected"),b.on("error",a._onError),b.on("message",function(b){"utf8"===b.type&&a._onMessage({data:b.utf8Data})}),b.obj=a,a._connection=b}),e.connect(a._url,"connect")}else console.warn("Incorrect URL: "+a._url),d();recolve(e)});return c},Cow.websocket.prototype.connection=function(){return this._connection},Cow.websocket.prototype.send=function(a){!this._connection||1!=this._connection.readyState&&"open"!=this._connection.state||this._connection.send(a)},Cow.websocket.prototype._onMessage=function(a){this._core.websocket().trigger("message",a)},Cow.websocket.prototype._onError=function(a){this._core.peerStore().clear(),this._connected=!1,console.warn("error in websocket connection: "+a.type),this._core.websocket().trigger("error")},Cow.websocket.prototype._onError=function(){console.log("closed")},_.extend(Cow.websocket.prototype,Events)}.call(this),function(){var a=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=Cow||{}),exports.Cow=Cow||{}):a.Cow=Cow||{},Cow.messenger=function(a){this._core=a.core,this.ws=this._core.websocket(),this.ws.on("message",this._onMessage),this.ws.on("error",this._onError)},Cow.messenger.prototype.sendData=function(a,b,c){var d={};d.sender=this._core.peerid(),d.target=c,d.action=b,d.payload=a;var e;try{e=JSON.stringify(d)}catch(f){console.error(f,d)}this.ws.send(e)},Cow.messenger.prototype._onMessage=function(a){var b=this._core,c=JSON.parse(a.data),d=c.sender,e=b.peerid(),f=c.action,g=c.payload,h=c.target;switch(f){case"command":d!=e&&this._core.messenger()._onCommand(c);break;case"connected":this._core.messenger()._onConnect(g);break;case"peerGone":this._core.messenger()._onPeerGone(g);break;case"newList":d!=e&&this._core.messenger()._onNewList(g,d);break;case"syncinfo":d!=e&&this._core.messenger()._onSyncinfo(g,d);break;case"wantedList":h==e&&this._core.messenger()._onWantedList(g);break;case"missingRecords":h==e&&this._core.messenger()._onMissingRecords(g);break;case"requestedRecords":d!=e&&this._core.messenger()._onMissingRecords(g);break;case"updatedRecord":d!=e&&this._core.messenger()._onUpdatedRecords(g)}},Cow.messenger.prototype._onClose=function(a){var b=(a.code,a.reason,a.wasClean,this.obj);console.log("WS disconnected:",this.closeDescription),b._core.peerStore().clear(),b._connected=!1;var c=function(){try{console.log("Trying to reconnect"),b._core.websocket().disconnect()}catch(a){console.warn(a)}b._core.websocket().connect().then(function(a){b._connection=a},function(a){console.warn("connection failed",a)})};setTimeout(c,5e3)},Cow.messenger.prototype._onConnect=function(a){console.log("connected!"),this._connected=!0;var b=this;this._core.peerid(a.peerID);var c=this._core.peers({_id:a.peerID}),d=(a.server_version,a.server_key);if(void 0!==d&&d!=this._core._herdname)return void b.disconnect();this._core.user()&&c.data("userid",this._core.user()._id),c.deleted(!1).sync(),this.trigger("connected",a),this._core.socketserverStore().sync(),this._core.peerStore().sync(),this._core.userStore().sync();var e=this._core.projectStore();e.sync(),e.loaded.then(function(){for(var a=b._core.projects(),c=0;c<a.length;c++){var d=a[c];b._core.projects(d._id).itemStore().sync(),b._core.projects(d._id).groupStore().sync()}})},Cow.messenger.prototype._onPeerGone=function(a){var b=a.gonePeerID.toString();this._core.peers(b)&&this._core.peers(b).deleted(!0).sync()},Cow.messenger.prototype._getStore=function(a){var b,c=a.syncType,d=a.project;switch(c){case"peers":return this._core.peerStore();case"socketservers":return this._core.socketserverStore();case"projects":return this._core.projectStore();case"users":return this._core.userStore();case"items":if(!d)throw"No project id given";return b=this._core.projects(this._core.projects(d)?d:{_id:d}),b.itemStore();case"groups":if(!d)throw"No project id given";return b=this._core.projects(this._core.projects(d)?d:{_id:d}),b.groupStore()}},Cow.messenger.prototype._onNewList=function(a,b){if(this._amIAlpha()){var c,d=this._getStore(a),e=d._projectid,f=d.compareRecords({uid:b,list:a.list}),g={IWillSent:_.pluck(f.pushlist,"_id"),IShallReceive:_.pluck(f.requestlist,"_id")};c={syncType:a.syncType,project:e,syncinfo:g},this.sendData(c,"syncinfo",b),c={syncType:a.syncType,project:e,list:f.requestlist},this.sendData(c,"wantedList",b),c={syncType:a.syncType,project:e,list:f.pushlist},this.sendData(c,"missingRecords",b)}},Cow.messenger.prototype._amIAlpha=function(){var a=null,b=_.sortBy(_.filter(this._core.peers(),function(a){return"alpha"==a.data("family")&&!a.deleted()}),function(a){return a.created()}),c=b[0],d=this._core.peer();return a=d.created()==c.created()?!0:!1},Cow.messenger.prototype._onSyncinfo=function(a){var b=this._getStore(a);b.syncinfo.toReceive=a.syncinfo.IWillSent,b.syncinfo.toSent=a.syncinfo.IShallReceive},Cow.messenger.prototype._onWantedList=function(a){var b=this._getStore(a),c=b.requestRecords(a.list),d={syncType:a.syncType,project:b._projectid,list:c};this.sendData(d,"requestedRecords")},Cow.messenger.prototype._onMissingRecords=function(a){var b,c=this._getStore(a),d=a.list,e=[];for(b=0;b<d.length;b++){var f=d[b],g=c._addRecord({source:"WS",data:f});if("projects"==c._type&&(g.groupStore().sync(),g.itemStore().sync()),f.deltas&&g.deltas()){var h=_.pluck(g.deltas(),"timestamp"),i=_.pluck(f.deltas,"timestamp"),j=_.difference(h,i);j.length>0&&e.push(g)}}for(b=0;b<e.length;b++)c.syncRecord(e[b]);c.trigger("datachange")},Cow.messenger.prototype._onUpdatedRecords=function(a){var b=this._getStore(a),c=a.record;b._addRecord({source:"WS",data:c}),b.syncinfo.toReceive=_.without(b.syncinfo.toReceive,c._id),b.trigger("datachange")},Cow.messenger.prototype._onCommand=function(a){{var b=this._core,c=a.payload,d=c.command,e=c.targetuser;c.params}if(this.trigger("command",a),"zoomTo"==d&&e&&e==b.user().id()&&this.trigger(d,c.location),"kickPeer"==d&&e&&e==b.peerid()&&(window.open("","_self",""),window.close()),"purgePeer"==d&&e&&e==this._core.peerid()&&(_.each(b.projects(),function(a){a.itemStore().clear(),a.groupStore().clear()}),b.projectStore().clear(),b.userStore().clear()),"flushProject"==d){var f,g=c.projectid;b.projects(g)&&(f=b.projects(g),f.itemStore().clear(),f.itemStore()._db.main.clear())}if("ping"==d){var h=a.sender;this.sendData({command:"pong"},"command",h)}},_.extend(Cow.messenger.prototype,Events)}.call(this),function(){var a=this;"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=Cow||{}),exports.Cow=Cow||{}):a.Cow=Cow||{},Cow.core=function(a){var b=this;"undefined"==typeof a&&(a={}),this._herdname=a.herdname||"cow",this._userid=null,this._socketserverid=null,this._projectid=null,this._wsUrl=null,this._peerid=null,this._maxAge=a.maxage||2592e6,this._localdb=new Cow.localdb({dbname:this._herdname,core:this}),this._projectStore=_.extend(new Cow.syncstore({dbname:"projects",noDeltas:!0,core:b,maxAge:this._maxAge}),{_records:[],_recordproto:function(a){return new Cow.project({_id:a,store:this})},_dbname:"projects",_type:"projects"}),this._peerStore=_.extend(new Cow.syncstore({dbname:"peers",noIDB:!0,noDeltas:!0,core:this,maxAge:this._maxAge}),{_records:[],_recordproto:function(a){return new Cow.peer({_id:a,store:this})},_dbname:"peers",_type:"peers",removePeer:function(a){return this._removeRecord(a)}}),this._userStore=_.extend(new Cow.syncstore({dbname:"users",noDeltas:!0,core:this,maxAge:this._maxAge}),{_records:[],_recordproto:function(a){return new Cow.user({_id:a,store:this})},_dbname:"users",_type:"users"}),this._socketserverStore=_.extend(new Cow.syncstore({dbname:"socketservers",noDeltas:!0,core:this,maxAge:this._maxAge}),{_records:[],_recordproto:function(a){return new Cow.socketserver({_id:a,store:this})},_dbname:"socketservers",_type:"socketservers"}),this._websocket=new Cow.websocket({core:this,url:this._wsUrl}),this._messenger=new Cow.messenger({core:this})},Cow.core.prototype={peerid:function(a){return a?(this._peerid=a.toString(),this._peerid):this._peerid?this._peerid.toString():null},project:function(a){if(a){a=a.toString();var b=this.projects(a);return b?(this._projectid=a,this.peer()&&this.peer().data("activeproject",a).sync(),this.trigger("projectChanged"),!0):(console.warn("Trying to select a non existing project"),!1)}return this._projectid?this.projects(this._projectid):!1},user:function(a){return a?(a=a.toString(),this._userid=a,this.peer()&&this.peers(this.peerid())&&this.peer().data("userid",a).sync(),this.users(a)):this._userid?this.users(this._userid):!1
},socketserver:function(a){return a?(a=a.toString(),this._socketserverid=a,this.socketservers(a)):this._socketserverid?this.socketservers(this._socketserverid):!1},peer:function(){return this.peerid()?this.peers(this.peerid()):!1},location:function(a){return a?(this._location=a,this.peerid()&&this.peers(this.peerid()).data("location",a).sync(),this._location):this._location},projectStore:function(){return this._projectStore},projects:function(a){return this._projectStore.records(a)},peerStore:function(){return this._peerStore},peers:function(a){return this._peerStore.records(a)},socketserverStore:function(){return this._socketserverStore},socketservers:function(a){return this._socketserverStore.records(a)},userStore:function(){return this._userStore},users:function(a){return this._userStore.records(a)},activeUsers:function(){for(var a=[],b=this.users(),c=0;c<b.length;c++)b[c].isActive()&&a.push(b[c]);return a},dbopen:function(){return this._localdb._openpromise},websocket:function(){return this._websocket},messenger:function(){return this._messenger},localdb:function(){return this._localdb},connect:function(){return this._websocket.connect()},disconnect:function(){return this._websocket.disconnect()}},_.extend(Cow.core.prototype,Events)}.call(this);