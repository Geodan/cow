<!DOCTYPE html>
<meta charset="utf-8">
<html>
  <head>
  <title>Concurrent Online Webgis</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <meta name="apple-mobile-web-app-capable" content="yes">

<!--  <link href='http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css' rel='stylesheet' type='text/css'>
-->  <link href='http://fonts.googleapis.com/css?family=Dosis:300,500' rel='stylesheet' type='text/css'>


  <script src="../lib/underscore/underscore-min.js" type="text/javascript"></script>
  <script src="../lib/jquery-2.0.3/jquery-2.0.3.js" type="text/javascript"></script>	
  <script src="../lib/jquery-ui-1.10.2/jquery-ui.js" type="text/javascript"></script>  
  <script src="../lib/jquery.indexeddb/jquery.indexeddb.min.js" type="text/javascript"></script>
  
  <!-- PouchDB -->
  <script src="../lib/pouchdb/pouchdb-nightly.js"></script>
<!--  
  <script src="http://openlayers.org/api/OpenLayers.js" type="text/javascript"></script>    
  <script src="http://maps.stamen.com/js/tile.stamen.js?v1.1.3"></script>
-->
  <!-- Adding leaflet and D3 libs, possible replacement for OL -->

  <script src="../lib/d3/d3.v3.min.js" charset="utf-8"></script>
  <script src="../lib/d3/topojson.v1.min.js"></script>
  
  <!--[if lte IE 8]>
	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6/leaflet.ie.css" />
  <![endif]-->

  <script src="./scripts/d3.jsonp.js" type="text/javascript"></script>
  <script src="./scripts/d3layer.js" type="text/javascript"></script>
  <script src="./scripts/d3layer_utils.js" type="text/javascript"></script>
  
  <!-- Peerjs -->
  <script type="text/javascript" src="../lib/peerjs-0.3/peer.min.js"></script>

  <script src="../src/cow2.utils.js" type="text/javascript"></script>
  <script src="../src/cow2.record.js" type="text/javascript"></script>
  <script src="../src/cow2.syncstore.js" type="text/javascript"></script>
  <script src="../src/cow2.peer.js" type="text/javascript"></script>
  <script src="../src/cow2.user.js" type="text/javascript"></script>
  <script src="../src/cow2.group.js" type="text/javascript"></script>
  <script src="../src/cow2.item.js" type="text/javascript"></script>
  <script src="../src/cow2.project.js" type="text/javascript"></script>
  <script src="../src/cow2.websocket.js" type="text/javascript"></script>
  <script src="../src/cow2.core.js" type="text/javascript"></script>
  <script src="../src/cow2.js" type="text/javascript"></script>
  
  <script src="scripts/cookies.js" type="text/javascript"></script>
<style>
.node circle {
  cursor: pointer;
  stroke: #3182bd;
  stroke-width: 1.5px;
}
 
.node text {
  font: 10px sans-serif;
  pointer-events: none;
  text-anchor: middle;
}
 
line.link {
  fill: none;
  stroke: #9ecae1;
  stroke-width: 1.5px;
}
</style>
<script type="text/javascript">



var core;





$(document).ready(function(){
  
  core = new Cow.core({
     wsUrl: 'wss://websocket.geodan.nl:443/new'
  });
  
  //TODO: move username admin to other place
  //Some username administration with cookies
  var username=getCookie("username");
  if (username!=null && username!="")
  {
    //core.username(username);
  }
  else 
  {
    username=prompt("Please enter your name:","");
    if (username!=null && username!="")
    {
        //core.username(username);
        setCookie("username",username,1);
    }
  }
  
  
  //Settings for ProGideon workshop
  var progideon = core.projects({_id:999,name:"Overstroming"})
    .data('peeruid', 'core.UID').sync(); 
  progideon.groups({_id:1}).data('name','Public');
  progideon.groups({_id:2}).data('name','Populatie');
  progideon.groups({_id:3}).data('name','Evacuatie');
  progideon.groups({_id:4}).data('name','Opvang');
  
  var progideon = core.projects({_id:998})
    .data({name:"Overstroming 2", peeruid: core.UID}); 
  progideon.groups({_id:1}).data('name','Public');
  progideon.groups({_id:2}).data('name','Populatie');
  progideon.groups({_id:3}).data('name','Evacuatie');
  progideon.groups({_id:4}).data('name','Opvang');
  //core.activeproject({activeProjectId:666});
  
  core.projectStore().initpromise.done(function(x){
    var findnode = function(nodename){
        var flat = flatten(root);
        $.each(flat, function(i,node){
            if (node.name = nodename){
                return node;
            }
        });
    };
  
  
      $.each(core.projects(), function(i,p){
        var project = {"name" : 'id'+p._id, "children": []};
        root.children.push(project);
        //p.itemStore().initpromise.done(function(x){
        //    var node = findnode('id'+q._id.toString());
        //    $.each(p.items(), function(i,q){
        //        
        //        var item = {"name": 'id'+q._id, size: 1000};
        //        if (node && node.children){
        //            node.children.push(item);
        //        }
        //    });
        //    //update();
        //});
        
      });
      update();
  /*
      var expand_project = function(d){
        var data = d.items();
        var item = d3.select(this).selectAll('p').data(data, function(e){return e._id});
        item.enter().append('p').html(function(e){return e._id});
        
      }
      
      var data = core.projects();
      var project = d3.select('#projectlist').selectAll('project')
        .data(data, function(d){return d._id.toString();});
       project.enter().append('div')
        .classed('project', true)
        .html(function(d){return '<h2>' + d._id + '</h2>'})
        .on('click', expand_project)
        .append('div')
        .attr('id', function(d){return 'project'+d._id;});
        */
   });
  
  
  //What to do when a user changes name
  $('#myname').on('blur', function(e, ui) {
    var username = $(this).val();
    //core.me().owner({name:username});
    //core.username(username);
    setCookie("username",username,1);
  });
  
  var root = {"name" : "PROJECTS", "children": []};
  
  
/** D3 **/  
    var width = 960,
        height = 500,
        root;
     
    var force = d3.layout.force()
        .linkDistance(80)
        .charge(-120)
        .gravity(.05)
        .size([width, height])
        .on("tick", tick);
     
    var svg = d3.select("#content").append("svg")
        .attr("width", width)
        .attr("height", height);
     
    var link = svg.selectAll(".link"),
        node = svg.selectAll(".node");
     
    
    
    update();
         
    function update() {
      var nodes = flatten(root),
          links = d3.layout.tree().links(nodes);
     
      // Restart the force layout.
      force
          .nodes(nodes)
          .links(links)
          .start();
     
      // Update links.
      link = link.data(links, function(d) { return d.target.id; });
     
      link.exit().remove();
     
      link.enter().insert("line", ".node")
          .attr("class", "link");
     
      // Update nodes.
      node = node.data(nodes, function(d) { return d.id; });
     
      node.exit().remove();
     
      var nodeEnter = node.enter().append("g")
          .attr("class", "node")
          .on("click", click)
          .call(force.drag);
     
      nodeEnter.append("circle")
          .attr("r", function(d) { return Math.sqrt(d.size) / 10 || 4.5; });
     
      nodeEnter.append("text")
          .attr("dy", ".35em")
          .text(function(d) { return d.name; });
     
      node.select("circle")
          .style("fill", color);
    }
     
    function tick() {
      link.attr("x1", function(d) { return d.source.x; })
          .attr("y1", function(d) { return d.source.y; })
          .attr("x2", function(d) { return d.target.x; })
          .attr("y2", function(d) { return d.target.y; });
     
      node.attr("transform", function(d) { return "translate(" + d.x + "," + d.y + ")"; });
    }
     
    function color(d) {
      return d._children ? "#3182bd" // collapsed package
          : d.children ? "#c6dbef" // expanded package
          : "#fd8d3c"; // leaf node
    }
     
    // Toggle children on click.
    function click(d) {
      if (d3.event.defaultPrevented) return; // ignore drag
      if (d.children) {
        d._children = d.children;
        d.children = null;
      } else {
        d.children = d._children;
        d._children = null;
      }
      update();
    }
     
    // Returns a list of all nodes under the root.
    function flatten(root) {
      var nodes = [], i = 0;
     
      function recurse(node) {
        if (node.children) node.children.forEach(recurse);
        if (!node.id) node.id = ++i;
        nodes.push(node);
      }
     
      recurse(root);
      return nodes;
    }
/** END OF D3**/
  
  
});
 

</script>
  </head>
  <body>
  <div id="top">
    <span id="connect" title="click to change connection status"></span>
    <span class="welcome"><span data-i18n="txt_welcome" id="txt_welcome">Welcome</span> <input id="myname"/ name="myname" title="click to change your name" value="anonymous" size="13"/></span>
  </div>
  <div id="content">
  <div id="projectlist"></div>
  </div>
  <div id="cow"></div>	
  <div id="help" ></div>
 
  </body>
</html>


